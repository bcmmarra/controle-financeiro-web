<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descomplica MyFinance</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    {% include 'menu.html' %} 
    
<main class="container-principal">
    <div class="container mt-3">
        {% with mensagens = get_flashed_messages(with_categories=true) %}
            {% if mensagens %}
                {% for categoria, mensagem in mensagens %}
                    <div class="alert alert-{{ 'success' if categoria == 'sucesso' else 'danger' }} alert-dismissible fade show" role="alert">
                        {{ mensagem }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="modal fade" id="simuladorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>Simulador de Compra Inteligente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSimulador">
                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary small">VALOR TOTAL DA COMPRA</label>
                            <input type="text" 
                                id="sim-valor-mask" 
                                class="form-control visor-calculadora" 
                                placeholder="0,00" 
                                style="text-align: right; font-size: 1.8rem; font-weight: bold; height: 60px; border: 2px solid #dee2e6; border-radius: 10px; padding-right: 15px;" 
                                required>
                            
                            <input type="hidden" id="sim-valor-real" name="valor">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Número de Parcelas</label>
                            <select class="form-select" id="sim-parcelas">
                                {% for i in range(1, 61) %}
                                    <option value="{{ i }}">{{ i }}x</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row g-2">
                            <div class="col-8">
                                <button type="button" class="btn btn-primary w-100 fw-bold" onclick="simularCompra()">
                                    <i class="fas fa-search-dollar me-2"></i>Analisar Melhor Momento
                                </button>
                            </div>
                            <div class="col-4">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="limparSimulacao()">
                                    <i class="fas fa-eraser"></i>
                                </button>
                            </div>
                        </div>

                    </form>

                    <div id="resultadoSimulacao" class="mt-4 d-none">
                        <div class="alert alert-info border-0 shadow-sm">
                            <h6 class="alert-heading fw-bold">Análise do Descomplica:</h6>
                            <p id="textoAnalise" class="mb-0 small"></p>
                        </div>
                        <div style="height: 250px; width: 100%; position: relative;">
                            <canvas id="chartSimulacao"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="calcModal" tabindex="-1" aria-hidden="true" data-bs-focus="false">
        <div class="modal-dialog modal-sm" style="position: fixed; bottom: 160px; right: 25px; margin: 0; width: 280px; z-index: 1060;">
            <div class="modal-content shadow-lg border-dark">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title fs-6"><i class="fas fa-calculator me-2"></i>Calculadora</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-2">
                    <input type="text" id="calc-display" class="form-control mb-3 text-end bg-white fs-4 fw-bold" readonly style="height: 50px; border: 2px solid #dee2e6;">
                    
                    <div class="row g-1">
                        <div class="col-9">
                            <div class="row g-1">
                                {% for btn in ['7','8','9','4','5','6','1','2','3','0','.','C'] %}
                                <div class="col-4">
                                    {% if btn == 'C' %}
                                        <button class="btn btn-danger w-100 fw-bold py-3" onclick="calcClear()">C</button>
                                    {% else %}
                                        <button class="btn btn-light border w-100 fw-bold py-3" onclick="calcInput('{{btn}}')">{{btn}}</button>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="col-3">
                            <div class="d-flex flex-column gap-1">
                                <button class="btn btn-dark w-100 fw-bold" onclick="calcInput('/')">/</button>
                                <button class="btn btn-dark w-100 fw-bold" onclick="calcInput('*')">*</button>
                                <button class="btn btn-dark w-100 fw-bold" onclick="calcInput('-')">-</button>
                                <button class="btn btn-dark w-100 fw-bold" onclick="calcInput('+')">+</button>
                                <button class="btn btn-success w-100 fw-bold flex-grow-1" style="min-height: 80px; font-size: 24px;" onclick="calcInput('=')">=</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {% block conteudo %}{% endblock %}
</main>

<footer class="main-footer">
    <div class="footer-container">
        <div class="footer-section footer-brand">
            <div class="footer-logo">
                <i class="fas fa-wallet"></i> <span>Descomplica MyFinance</span>
            </div>
            <p class="footer-description">
                Simplificando seu controle financeiro diário com inteligência e praticidade.
            </p>
        </div>

        <div class="footer-section">
            <h4 class="footer-title">Navegação</h4>
            <nav class="footer-links">
                <a href="{{ url_for('index') }}"><i class="fas fa-chart-line"></i> Resumo</a>
                <a href="{{ url_for('listagem') }}"><i class="fas fa-list-ul"></i> Extrato</a>
                <a href="javascript:void(0)" onclick="openSupport()"><i class="fas fa-question-circle"></i> Suporte</a>
            </nav>
        </div>

        <div class="footer-section">
            <h4 class="footer-title">Redes Sociais</h4>
            <div class="footer-social">
                <a href="https://www.instagram.com/bruno_c_marra" title="Instagram" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://www.linkedin.com/in/bruno-cassio-marra" title="LinkedIn" target="_blank" ><i class="fab fa-linkedin-in"></i></a>
                <a href="https://github.com/bcmmarra" title="GitHub" target="_blank"><i class="fab fa-github"></i></a>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2026 Descomplica MyFinance. Todos os direitos reservados.</p>
    </div>
</footer>

<div id="supportModal" class="support-modal">
    <div class="support-content">
        <div class="support-header">
            <h3><i class="fas fa-headset"></i> Como podemos ajudar?</h3>
            <span class="close-modal" onclick="closeSupport()">&times;</span>
        </div>
        <div class="support-body">
            <p>Escolha um canal de atendimento abaixo:</p>
            
            <a href="https://wa.me/5531991853333?text=Olá,%20preciso%20de%20ajuda%20com%20o%20Descomplica%MyFinance!" target="_blank" class="support-item">
                <i class="fab fa-whatsapp"></i>
                <div>
                    <strong>WhatsApp</strong>
                    <span>Atendimento rápido (Seg-Sex)</span>
                </div>
            </a>

            <a href="mailto:bcm.marra@gmail.com" class="support-item">
                <i class="far fa-envelope"></i>
                <div>
                    <strong>E-mail</strong>
                    <span>Retorno em até 24 horas</span>
                </div>
            </a>

            <a href="{{ url_for('ajuda') }}" class="support-item">
                <i class="fas fa-book"></i>
                <div>
                    <strong>Central de Ajuda</strong>
                    <span>Tutoriais e FAQs</span>
                </div>
            </a>
        </div>
    </div>
</div>

{% if not esconder_botoes %}
<div class="fab-container">
    <button type="button" class="fab-sim" data-bs-toggle="modal" data-bs-target="#simuladorModal" title="Simular Compra">
        <i class="fas fa-chart-line"></i>
    </button>

    <button type="button" class="fab-calc" data-bs-toggle="modal" data-bs-target="#calcModal" title="Calculadora">
        <i class="fas fa-calculator"></i>
    </button>

    <a href="{{ url_for('novo_lancamento') }}" class="fab-botao" title="Novo Lançamento">
        <i class="fas fa-plus"></i>
    </a>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script> 
    function openSupport() {
        document.getElementById("supportModal").style.display = "block";
    }

    function closeSupport() {
        document.getElementById("supportModal").style.display = "none";
    }

    window.onclick = function(event) {
        let modal = document.getElementById("supportModal");
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Tenta recuperar a última conta salva ou inicia vazia
    let calcExpressao = localStorage.getItem('minha_ultima_conta') || "";

    // Função para atualizar o display assim que a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        const display = document.getElementById('calc-display');
        if (display && calcExpressao) {
            display.value = calcExpressao;
        }
    });

    function calcInput(valor) {
        const display = document.getElementById('calc-display');
        
        if (valor === '=') {
            try {
                let resultado = eval(calcExpressao);
                calcExpressao = (Math.round(resultado * 100) / 100).toString();
            } catch (e) {
                calcExpressao = "Erro";
                setTimeout(calcClear, 1000);
            }
        } else {
            calcExpressao += valor;
        }
        
        display.value = calcExpressao;
        // SALVA NA MEMÓRIA DO NAVEGADOR
        localStorage.setItem('minha_ultima_conta', calcExpressao);
    }

    function calcClear() {
        calcExpressao = "";
        document.getElementById('calc-display').value = "";
        localStorage.removeItem('minha_ultima_conta');
    }

    document.getElementById('sim-valor-mask').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, "");
        
        // Formatação para Real R$
        if (value === "") {
            e.target.value = "";
        } else {
            value = (value / 100).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            e.target.value = "R$ " + value;
        }

        // Guarda o valor puro (ex: 1250.50) no hidden para o Python
        const valorPuro = value.replace(/[^\d,]/g, "").replace(",", ".");
        document.getElementById('sim-valor-real').value = valorPuro;
    });


    let chartInstancia = null;

        async function simularCompra() {
            const valorPuro = document.getElementById('sim-valor-real').value;
            const parcelas = document.getElementById('sim-parcelas').value;

            // Validação básica de entrada
            if (!valorPuro || valorPuro <= 0) {
                alert("Por favor, insira um valor válido para a compra.");
                return;
            }

            try {
                const response = await fetch('/api/simular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor: valorPuro, parcelas: parcelas })
                });

                const data = await response.json();

                if (data.erro) {
                    alert("Erro no servidor: " + data.erro);
                    return;
                }

                // 1. EXIBIR CONTAINER DE RESULTADOS
                const resultadoDiv = document.getElementById('resultadoSimulacao');
                resultadoDiv.classList.remove('d-none');
                
                // 2. TRATAMENTO DO TEXTO DE ANÁLISE (Considerando saldo negativo)
                const folgaVal = Number(data.maior_folga);
                const folgaFormatada = folgaVal.toLocaleString('pt-BR', { 
                    style: 'currency', 
                    currency: 'BRL' 
                });

                const textoAnalise = document.getElementById('textoAnalise');
                if (folgaVal < 0) {
                    textoAnalise.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i> 
                        Atenção: Nenhum mês possui folga positiva. O menos crítico é <strong>${data.melhor_mes}</strong> com saldo de <strong>${folgaFormatada}</strong>.</span>`;
                } else {
                    textoAnalise.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> 
                        O melhor mês para iniciar é <strong>${data.melhor_mes}</strong> com folga de <strong>${folgaFormatada}</strong>.`;
                }

                // 3. RENDERIZAR GRÁFICO (Com trava de segurança para não crescer infinito)
                const canvas = document.getElementById('chartSimulacao');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Destruição obrigatória para evitar loops de renderização
                if (chartInstancia) { 
                    chartInstancia.destroy(); 
                }

                chartInstancia = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.analise.map(item => item.mes_nome),
                        datasets: [{
                            label: 'Saldo Projetado',
                            data: data.analise.map(item => item.saldo_previsto),
                            backgroundColor: data.analise.map(item => item.saldo_previsto >= 0 ? '#28a745' : '#dc3545'),
                            borderRadius: 5,
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, // IMPEDE O CRESCIMENTO INFINITO
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });

            } catch (err) {
                console.error("Erro na requisição:", err);
                alert("Ocorreu um erro ao processar a simulação. Verifique o console.");
            }
        }

        function limparSimulacao() {
            // 1. Limpa os inputs
            document.getElementById('sim-valor-mask').value = "";
            document.getElementById('sim-valor-real').value = "";
            document.getElementById('sim-parcelas').value = "1";

            // 2. Esconde a div de resultados
            const resultadoDiv = document.getElementById('resultadoSimulacao');
            resultadoDiv.classList.add('d-none');

            // 3. Destrói o gráfico para o canvas ficar limpo
            if (chartInstancia) {
                chartInstancia.destroy();
                chartInstancia = null;
            }
            
            // 4. Foca no campo de valor para a próxima simulação
            document.getElementById('sim-valor-mask').focus();
        }
        document.getElementById('simuladorModal').addEventListener('hidden.bs.modal', function () {
            limparSimulacao();
        });
</script>

{% block scripts %}{% endblock %}
</body>
</html>