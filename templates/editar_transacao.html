{% extends 'base.html' %}

{% block conteudo %}
<div class="form-container-small">
    <h2 class="page-title">Editar Transação</h2>

    <div class="card card-formulario">
        <form action="/atualizar/{{ transacao.id }}" method="POST" onsubmit="removerMascaraAntesDeEnviar()">

            <div class="form-row">
                <div class="form-group">
                    <label>Data:</label>
                    <input type="date" name="data_transacao" value="{{ transacao.data_transacao }}" class="form-control" required>
                </div>


                <div class="form-group">
                    <label>Valor (R$):</label>
                    <input type="text" id="valor_exibicao" name="valor_total" value="{{ transacao.valor_total }}" class="form-control" required>
                    <input type="hidden" name="valor_total" id="valor_real" value="{{ transacao.valor_total }}">
                </div>
            </div>

            <div class="form-group">
                <label>Descrição:</label>
                <input type="text" name="descricao" value="{{ transacao.descricao }}" class="form-control" required>
            </div>

            <div class="form-group">
                <label>Categoria:</label>
                <select name="categoria_id" class="form-control" required>
                    {% for cat in categorias %}
                    <option value="{{ cat.id }}" {% if cat.id == transacao.categoria_id %}selected{% endif %}>
                        {{ cat.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Método de Pagamento:</label>
                <select name="metodo" class="form-control">
                    <option value="Dinheiro" {% if transacao.metodo_pagamento == 'Dinheiro' %}selected{% endif %}>Dinheiro</option>
                    <option value="Cartão de Crédito" {% if transacao.metodo_pagamento == 'Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                    <option value="Pix" {% if transacao.metodo_pagamento == 'Pix' %}selected{% endif %}>Pix</option>
                    <option value="Boleto" {% if transacao.metodo_pagamento == 'Boleto' %}selected{% endif %}>Boleto</option>
                </select>
            </div>

            <div class="form-checkbox">
                <input type="checkbox" name="pago" id="pago" {% if transacao.pago %}checked{% endif %}>
                <label for="pago">Status: Já está pago?</label>
            </div>

            {% if transacao.id_transacao_pai or transacao.is_parcelado %}
            <div class="alert-info-parcela">
                <p class="alerta-titulo">
                    <i class="fas fa-layer-group"></i> <strong>Esta conta faz parte de um parcelamento</strong>
                </p>

                <div class="form-group" style="margin-top: 15px;">
                    <label>Alterar total de parcelas para:</label>
                    <input type="number" name="novo_total_parcelas" value="{{ transacao.numero_parcelas }}"
                           min="{{ transacao.parcela_atual }}" class="form-control">
                    <small class="form-help">Atual: {{ transacao.numero_parcelas }} parcelas (Esta é a {{ transacao.parcela_atual }}ª)</small>
                </div>

                <div class="opcoes-edicao-grupo">
                    <label class="radio-item">
                        <input type="radio" name="tipo_edicao" value="individual" checked>
                        <span>Editar <strong>apenas esta</strong> parcela</span>
                    </label>

                    <label class="radio-item">
                        <input type="radio" name="tipo_edicao" value="grupo">
                        <span>Aplicar para <strong>todo o grupo</strong></span>
                    </label>
                </div>
            </div>
            {% endif %}

            <div class="form-actions-flex">
                <button type="submit" class="btn-confirmar">
                    <i class="fas fa-check"></i> Salvar Alterações
                </button>
                <a href="/listagem" class="btn-cancelar">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputValor = document.getElementById('valor_exibicao');

    // 1. Formata o valor assim que a página carrega
    if (inputValor.value) {
        inputValor.value = formatarMoedaInicial(inputValor.value);
    }

    // 2. Máscara em tempo real enquanto digita
    inputValor.addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, '');
        v = (v / 100).toFixed(2).replace('.', ',');
        v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        e.target.value = 'R$ ' + v;
    });

    // 3. LIMPEZA TOTAL antes de enviar para o Python
    // Isso remove o "R$", os "." e troca a "," por "."
    inputValor.closest('form').addEventListener('submit', function() {
        let valorRaw = inputValor.value;
        // Remove tudo que não é dígito ou vírgula, depois trata para float
        let valorLimpo = valorRaw.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
        inputValor.value = valorLimpo; 
    });

    function formatarMoedaInicial(valor) {
        let num = parseFloat(valor).toFixed(2).replace('.', ',');
        num = num.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        return 'R$ ' + num;
    }
});
</script>

<style>
    #valor_exibicao {
        font-weight: bold;
        color: #2c3e50;
    }
</style>
{% endblock %}