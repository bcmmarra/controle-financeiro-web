{% extends 'base.html' %}

{% block conteudo %}
<div class="form-container-small">
    <h2 class="page-title">Editar Transação</h2>

    <div class="card card-formulario">
        <form action="{{ url_for('atualizar_transacao', id=transacao.id) }}" method="POST">
        
            <div class="form-group mb-3">
                <label class="form-label font-weight-bold">Tipo de Transação</label>
                <div class="d-flex gap-3 p-2 border rounded bg-light">
                    <div class="custom-control custom-radio">
                        <input type="radio" id="tipo_despesa" name="tipo" value="despesa" class="custom-control-input" 
                               {% if transacao.tipo == 'despesa' %}checked{% endif %} onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-danger font-weight-bold" for="tipo_despesa">Despesa</label>
                    </div>
                    <div class="custom-control custom-radio ml-4">
                        <input type="radio" id="tipo_receita" name="tipo" value="receita" class="custom-control-input" 
                               {% if transacao.tipo == 'receita' %}checked{% endif %} onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-success font-weight-bold" for="tipo_receita">Receita</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Data:</label>
                    <input type="date" name="data_transacao" value="{{ transacao.data_transacao }}" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Valor (R$):</label>
                    <input type="text" id="valor_exibicao" class="form-control" required>
                    <input type="hidden" name="valor_total" id="valor_real" value="{{ transacao.valor_total }}">
                </div>
            </div>

            <div class="form-group">
                <label>Descrição:</label>
                <input type="text" name="descricao" value="{{ transacao.descricao }}" class="form-control" required>
            </div>

            <div class="form-group">
                <label>Categoria:</label>
                <select name="categoria_id" class="form-control" required>
                    {% for cat in categorias %}
                    <option value="{{ cat.id }}" {% if cat.id == transacao.categoria_id %}selected{% endif %}>
                        {{ cat.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div id="secao_detalhes_despesa">
               <div class="form-group">
                    <label>Método de Pagamento:</label>
                    <select name="metodo" id="metodo" class="form-control">
                        <option value="Dinheiro" {% if transacao.metodo == 'Dinheiro' %}selected{% endif %}>Dinheiro</option>
                        <option value="Cartão de Crédito" {% if transacao.metodo == 'Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                        <option value="Pix" {% if transacao.metodo == 'Pix' %}selected{% endif %}>Pix</option>
                        <option value="Boleto" {% if transacao.metodo == 'Boleto' %}selected{% endif %}>Boleto</option>
                    </select>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" name="pago" id="pago" {% if transacao.pago %}checked{% endif %}>
                    <label for="pago">Status: Já está pago?</label>
                </div>
            </div>

            <div id="campos_parcelas" class="alert-info-parcela mt-3" style="display: none;">
                <p class="alerta-titulo"><i class="fas fa-layer-group"></i> <strong>Parcelamento</strong></p>
                
                <label>Quantidade de Parcelas:</label>
                <input type="number" name="novo_total_parcelas" id="numero_parcelas" 
                    value="{{ transacao.numero_parcelas or 1 }}" 
                    min="{{ transacao.parcela_atual or 1 }}" class="form-control">

                {% if transacao.is_parcelado %}
                <div class="opcoes-edicao-grupo mt-2 p-2 border-top">
                    <label class="d-block small text-muted">Aplicar alteração em:</label>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="edit_individual" name="tipo_edicao" value="individual" class="custom-control-input" checked>
                        <label class="custom-control-label" for="edit_individual">Apenas esta</label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="edit_grupo" name="tipo_edicao" value="grupo" class="custom-control-input">
                        <label class="custom-control-label" for="edit_grupo">Todas as parcelas</label>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="form-actions-flex mt-4">
                <button type="submit" class="btn-confirmar"><i class="fas fa-check"></i> Salvar Alterações</button>
                <a href="/listagem" class="btn-cancelar">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
function ajustarVisibilidade() {
    const isDespesa = document.getElementById("tipo_despesa").checked;
    const secao = document.getElementById("secao_detalhes_despesa");
    const infoParcela = document.getElementById("info_parcelamento");

    if (isDespesa) {
        secao.style.display = "block";
        if(infoParcela) infoParcela.style.display = "block";
    } else {
        secao.style.display = "none";
        if(infoParcela) infoParcela.style.display = "none";
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const inputExibicao = document.getElementById('valor_exibicao');
    const inputReal = document.getElementById('valor_real');

    function formatarMoeda(valor) {
        let v = valor.replace(/\D/g, "");
        if (v === "") v = "0";
        v = (v / 100).toFixed(2).replace(".", ",");
        v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        return "R$ " + v;
    }

    // Inicialização segura
    if (inputReal && inputReal.value) {
        let valorLimpo = inputReal.value.replace(".", "");
        inputExibicao.value = formatarMoeda(valorLimpo);
    }

    inputExibicao.addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, "");
        inputReal.value = (v / 100).toFixed(2); // Atualiza o hidden para o Python
        e.target.value = formatarMoeda(v);
    });
});

function gerenciarCamposParcelas() {
    const tipoDespesa = document.getElementById('tipo_despesa');
    const metodoPgto = document.getElementById('metodo');
    const divParcelas = document.getElementById('campos_parcelas');

    if (!tipoDespesa || !metodoPgto || !divParcelas) return;

    // Lógica: Mostrar parcelas apenas se for DESPESA e MÉTODO for CARTÃO DE CRÉDITO
    if (tipoDespesa.checked && metodoPgto.value === "Cartão de Crédito") {
        divParcelas.style.display = "block";
    } else {
        divParcelas.style.display = "none";
        // Resetamos para 1 se esconder, para evitar envio acidental de múltiplas parcelas
        const inputParcelas = divParcelas.querySelector('input[type="number"]');
        if (inputParcelas && !inputParcelas.readOnly) {
            inputParcelas.value = 1;
        }
    }
}

// Inicialização e Listeners
document.addEventListener('DOMContentLoaded', function() {
    const elementosGatilho = [
        document.getElementById('tipo_despesa'),
        document.getElementById('tipo_receita'),
        document.getElementById('metodo')
    ];

    elementosGatilho.forEach(el => {
        if (el) el.addEventListener('change', gerenciarCamposParcelas);
    });

    // Executa ao carregar a página (importante para a Edição)
    gerenciarCamposParcelas();
});

</script>
{% endblock %}