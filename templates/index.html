{% extends 'base.html' %} {% block conteudo %}
<div class="dashboard-header">
  <h2 class="dashboard-title">
    Resumo Financeiro - {{ mes_atual_pt }} / {{ datetime_now.year }}
  </h2>

  <div class="nav-buttons">
    <a
      href="/?mes={{ data_anterior.month }}&ano={{ data_anterior.year }}"
      class="btn-nav"
    >
      <i class="fas fa-chevron-left"></i> Anterior
    </a>
    <a
      href="/?mes={{ data_proxima.month }}&ano={{ data_proxima.year }}"
      class="btn-nav"
    >
      Pr√≥ximo <i class="fas fa-chevron-right"></i>
    </a>
  </div>
</div>

    
<hr class="divisor-filtro">

<div class="row mb-2">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #1cc88a; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Receitas (Entradas)</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_receitas | moeda }}</div>
                </div>
                <i class="fas fa-hand-holding-usd fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
        <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #5a5c69; background-color: #f8f9fc; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-muted" style="font-size: 0.8rem; line-height: 1;">Total de Despesas</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_geral | moeda }}</div>
                </div>
                <i class="fas fa-file-invoice-dollar text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #4e73df; background-color: #f8fbff; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-primary" style="font-size: 0.8rem; line-height: 1;">Saldo Projetado</div>
                    <div class="h5 mb-0 font-weight-bold {{ 'text-danger' if saldo_atual < 0 else 'text-gray-800' }}">
                        {{ saldo_atual | moeda }}
                    </div>
                </div>
                <i class="fas fa-wallet fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #28a745; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Total Pago</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pago | moeda }}</div>
                </div>
                <i class="fas fa-check-double text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #fd7e14; background-color: #fffaf5; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-warning" style="font-size: 0.8rem; line-height: 1;">Aguardando Pagamento</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pendente | moeda }}</div>
                </div>
                <i class="fas fa-clock text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4 no-print">
    <div class="col-12">
        <div class="card shadow py-1" style="border-left: 10px solid {{ '#e74a3b' if saldo_atual < 0 else '#1cc88a' }}; background-color: {{ '#fff5f5' if saldo_atual < 0 else '#f1fcf4' }}; border-radius: 12px;">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div style="flex-grow: 1;">
                    <div class="text-sm font-weight-bold text-info text-uppercase mb-2">
                        <i class="fas fa-shield-alt"></i> Diagn√≥stico da Sa√∫de Financeira
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="h3 mb-0 font-weight-bold mr-3 {{ 'text-danger' if saldo_atual < 0 else 'text-success' }}">
                            {{ status_financeiro }}
                        </span>
                        <span class="badge badge-pill badge-dark" style="padding: 6px 10px;">{{ mes_atual_pt }}</span>
                    </div>
                    <p class="text-muted mt-2 mb-0" style="font-size: 0.95rem;">
                        <strong>Dica do Sistema:</strong> {{ sugestao }}
                    </p>
                </div>
                <div class="d-none d-md-block ml-4">
                    <i class="fas {{ 'fa-exclamation-triangle text-danger' if saldo_atual < 0 else 'fa-check-circle text-success' }} fa-4x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="divisor-filtro">

{% if total_atrasadas > 0 %}
<div class="alert-atrasadas">
  <i class="fas fa-exclamation-triangle"></i>
  <span
    >Voc√™ possui <strong>{{ total_atrasadas }}</strong> conta(s) pendente(s) de
    meses anteriores.</span
  >
  <a href="{{ url_for('listagem', filtro='atrasadas') }}" class="btn-alert-link"
    >Ver agora</a
  >
</div>
{% endif %}

<div class="grid-central">
  <div class="card card-carrossel">
    <h4 class="card-subtitle">Pr√≥ximas Contas</h4>

    <div id="carrossel-contas">
      {% for conta in proximas_contas %}
      <div
        class="item-conta"
        style="display: {% if loop.first %}block{% else %}none{% endif %};"
      >
        <div class="item-conta-content">
          <div>
            <h2 class="item-valor">{{ conta.valor_total | moeda }}</h2>
            <p class="item-desc">{{ conta.descricao }}</p>
            <small class="item-vencimento"
              >Vence em: {{ conta.data_transacao.strftime('%d/%m') }}</small
            >
          </div>

          <form
            action="{{ url_for('alternar_pagamento', id=conta.id) }}"
            method="POST"
          >
            <button
              type="submit"
              title="Marcar como pago"
              class="btn-check-pago"
            >
              <i class="fas fa-check"></i>
            </button>
          </form>
        </div>
      </div>
      {% endfor %} {% if not proximas_contas %}
      <p class="msg-vazio">Tudo em dia! üôå</p>
      {% endif %}
    </div>

    {% if proximas_contas|length > 1 %}
    <div class="carrossel-controls">
      <button
        onclick="mudarConta(-1)"
        class="btn-carrossel"
        title="Conta Anterior"
      >
        <i class="fas fa-chevron-left"></i>
      </button>
      <span id="contador-carrossel" class="contador-carrossel">
        1 / {{ proximas_contas|length }}
      </span>
      <button
        onclick="mudarConta(1)"
        class="btn-carrossel"
        title="Pr√≥xima Conta"
      >
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    {% endif %}
  </div>

  <div class="card-atalho">
    <p class="atalho-texto">Registrar novo gasto?</p>
    <a href="/novo_lancamento" class="btn-principal">+ Nova Transa√ß√£o</a>
  </div>
</div>

<hr class="divisor-filtro">

<div class="grid-graficos">
  <div class="card-grafico">
    <h3 class="card-grafico-title">Gastos por Categoria</h3>
    <div class="chart-container">
      {% if labels %}
      <canvas id="graficoCategorias"></canvas>
      {% else %}
      <div class="chart-vazio">
        <i class="fas fa-chart-pie fa-3x"></i>
        <p>Nenhum dado por categoria</p>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="card-grafico">
    <h3 class="card-grafico-title">Por Pagamento</h3>
    <div class="lista-pagamentos-container">
      {% if labels_metodos %}
      <ul class="lista-pagamentos">
        {% for i in range(labels_metodos|length) %}
        <li class="item-pagamento">
          <span class="metodo-nome">
            <i class="fas fa-credit-card"></i> {{ labels_metodos[i] }}
          </span>
          <span class="metodo-valor">{{ valores_metodos[i] | moeda }}</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="chart-vazio">
        <i class="fas fa-wallet fa-3x"></i>
        <p>Sem dados de pagamento</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<hr class="divisor-filtro">

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Comparativo: Entradas vs Sa√≠das (Ano {{ datetime_now.year }})</h5>
    </div>
    <div class="card-body">
        <div style="height: 300px;">
            <canvas id="canvasFluxoCaixa"></canvas>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Configura√ß√µes Globais
    const formatarMoeda = (valor) => {
        return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    // 2. Captura das vari√°veis (Apenas o que importa agora)
    const labelsCategorias = {{ labels|tojson|safe if labels else '[]' }};
    const valoresCategorias = {{ valores|tojson|safe if valores else '[]' }};
    const coresCategorias = {{ cores|tojson|safe if cores else '[]' }};
    
    const dadosReceitasAnuais = {{ receitas_anuais | tojson | safe }};
    const dadosDespesasAnuais = {{ despesas_anuais | tojson | safe }};

    // 3. Gr√°fico de Fluxo de Caixa Anual (SUBSTITUI O DE EVOLU√á√ÉO)
    const ctxFluxoAnual = document.getElementById('canvasFluxoCaixa');
    if (ctxFluxoAnual) {
        new Chart(ctxFluxoAnual, {
            type: 'bar',
            data: {
                labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
                datasets: [
                    {
                        label: 'Entradas (Receitas)',
                        data: dadosReceitasAnuais,
                        backgroundColor: 'rgba(39, 174, 96, 0.7)',
                        borderColor: '#27ae60',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Sa√≠das (Despesas)',
                        data: dadosDespesasAnuais,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${formatarMoeda(context.raw)}`
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: (v) => formatarMoeda(v) } }
                }
            }
        });
    }

    // 4. Gr√°fico de Categorias (Pizza) - Mantido
    const ctxCategorias = document.getElementById('graficoCategorias');
    if (ctxCategorias && labelsCategorias.length > 0) {
        new Chart(ctxCategorias, {
            type: 'doughnut',
            data: {
                labels: labelsCategorias,
                datasets: [{
                    data: valoresCategorias,
                    backgroundColor: coresCategorias,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "70%",
                plugins: {
                    legend: { position: "bottom" },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.label}: ${formatarMoeda(context.raw)}`
                        }
                    }
                }
            }
        });
    }
    // --- 5. L√ìGICA DO CARROSSEL DE CONTAS ---
    let indiceAtual = 0;
    const listaDeContas = document.querySelectorAll(".item-conta");
    const labelContador = document.getElementById("contador-carrossel");

    window.mudarConta = function(direcao) {
        if (listaDeContas.length <= 1) return;
        listaDeContas[indiceAtual].style.display = "none";
        indiceAtual = (indiceAtual + direcao + listaDeContas.length) % listaDeContas.length;
        listaDeContas[indiceAtual].style.display = "block";
        if (labelContador) labelContador.innerText = (indiceAtual + 1) + " / " + listaDeContas.length;
    };

    // --- 6. M√ÅSCARA DE MOEDA ---
    const camposMoeda = document.querySelectorAll('input[name="valor"]');
    camposMoeda.forEach(campo => {
        if (typeof SimpleMaskMoney !== 'undefined') {
            SimpleMaskMoney.setMask(campo, {
                prefix: 'R$ ',
                fixed: true,
                fractionDigits: 2,
                decimalSeparator: ',',
                thousandsSeparator: '.',
                cursor: 'end'
            });
        }
    });
</script>
{% endblock %}
