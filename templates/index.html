{% extends 'base.html' %} 

{% block conteudo %}
<div class="dashboard-header">
  <h2 class="dashboard-title">
    Resumo Financeiro - {{ mes_atual_pt }} / {{ datetime_now.year }}
  </h2>

  <div class="nav-buttons">
    <a href="/?mes={{ data_anterior.month }}&ano={{ data_anterior.year }}" class="btn-nav">
      <i class="fas fa-chevron-left"></i> Anterior
    </a>
    <a href="/?mes={{ data_proxima.month }}&ano={{ data_proxima.year }}" class="btn-nav">
      Pr√≥ximo <i class="fas fa-chevron-right"></i>
    </a>
  </div>
</div>

<hr class="divisor-filtro">

{% if total_atrasadas > 0 %}
<div class="alert-atrasadas">
  <i class="fas fa-exclamation-triangle"></i>
  <span>Voc√™ possui <strong>{{ total_atrasadas }}</strong> conta(s) pendente(s) de meses anteriores.</span>
  <a href="{{ url_for('listagem', filtro='atrasadas') }}" class="btn-alert-link">Ver agora</a>
</div>
{% endif %}

<hr class="divisor-filtro">

<div class="row mb-2">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #1cc88a; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Receitas (Entradas)</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_receitas | moeda }}</div>
                </div>
                <i class="fas fa-hand-holding-usd fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #5a5c69; background-color: #f8f9fc; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-muted" style="font-size: 0.8rem; line-height: 1;">Total de Despesas</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_despesas | moeda }}</div>
                </div>
                <i class="fas fa-file-invoice-dollar text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #4e73df; background-color: #f8fbff; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-primary" style="font-size: 0.8rem; line-height: 1;">Saldo Projetado</div>
                    <div class="h5 mb-0 font-weight-bold {{ 'text-danger' if saldo_atual < 0 else 'text-gray-800' }}">
                        {{ saldo_atual | moeda }}
                    </div>
                </div>
                <i class="fas fa-wallet fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-2">
  <div class="col-md-4 mb-3">
      <div class="card shadow-sm" style="border-left: 4px solid #28a745; background-color: #f8fff9; height: 70px;">
          <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
              <div>
                  <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Total Pago</div>
                  <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pago | moeda }}</div>
              </div>
              <i class="fas fa-check-double text-gray-300"></i>
          </div>
      </div>
  </div>
  <div class="col-md-4 mb-3">
      <div class="card shadow-sm" style="border-left: 4px solid #fd7e14; background-color: #fffaf5; height: 70px;">
          <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
              <div>
                  <div class="text-uppercase font-weight-bold text-warning" style="font-size: 0.8rem; line-height: 1;">Aguardando Pagamento</div>
                  <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pendente | moeda }}</div>
              </div>
              <i class="fas fa-clock text-gray-300"></i>
          </div>
      </div>
  </div>
</div>

<div class="row mb-4 no-print">
    <div class="col-12">
        <div id="container-saude" class="card shadow py-1" style="border-left: 10px solid {{ '#e74a3b' if saldo_atual < 0 else ('#f6e05e' if percentual_gasto > 80 else '#1cc88a') }}; background-color: {{ '#fff5f5' if saldo_atual < 0 else ('#fffdf0' if percentual_gasto > 80 else '#f1fcf4') }}; border-radius: 12px;">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div style="flex-grow: 1;">
                    <div class="text-sm font-weight-bold text-info text-uppercase mb-2">
                        <i class="fas fa-shield-alt"></i> Diagn√≥stico da Sa√∫de Financeira
                    </div>
                    <div class="d-flex align-items-center">
                        <span id="txt-saude" class="h3 mb-0 font-weight-bold mr-3 
                            {{ 'text-danger' if saldo_atual < 0 else ('text-warning' if percentual_gasto > 80 else 'text-success') }}">
                            {{ status_financeiro }}
                        </span>
                    </div>
                    <p id="txt-dica" class="text-muted mt-2 mb-0" style="font-size: 0.95rem;">
                        <strong>Dica:</strong> {{ sugestao }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="divisor-filtro">

<div class="grid-central">
  <div class="card shadow-sm border-0 bg-gradient-blue text-white" style="background: linear-gradient(45deg, #2980b9, #3498db); border-radius: 15px; min-height: 200px;">
      <div class="card-body d-flex flex-column justify-content-between">
          <div class="d-flex justify-content-between align-items-start">
              <div>
                <p class="text-white-50 small mb-1 text-uppercase font-weight-bold">Aporte Mensal</p>
                <h3 class="mb-0 font-weight-bold">
                    {{ total_investimentos | moeda }}
                </h3>
              </div>
              <div class="rounded-circle p-2" style="background: rgba(255,255,255,0.2);">
                  <i class="fas fa-chart-line fa-lg"></i>
              </div>
          </div>
          
          <div class="mt-auto">
              <div class="progress" style="height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px;">
                  <div class="progress-bar bg-white" role="progressbar" 
                      style="width: {{ taxa_investimento if taxa_investimento <= 100 else 100 }}%; border-radius: 10px;"></div>
              </div>
              <p class="mt-2 mb-0 small">
                  <strong>{{ "%.1f"|format(taxa_investimento) }}%</strong> da receita investida
              </p>
          </div>
      </div>
  </div>

  <div class="card card-carrossel">
    <h4 class="card-subtitle">Pr√≥ximas Contas</h4>
    <div id="carrossel-contas">
      {% for conta in proximas_contas %}
      <div class="item-conta" style="display: {% if loop.first %}block{% else %}none{% endif %};">
        <div class="item-conta-content">
          <div>
            <h2 class="item-valor">{{ conta.valor_total | moeda }}</h2>
            <p class="item-desc">{{ conta.descricao }}</p>
            <small class="item-vencimento">Vence em: {{ conta.data_transacao.strftime('%d/%m') }}</small>
          </div>
          <form action="{{ url_for('alternar_pagamento', id=conta.id) }}" method="POST">
            <button type="submit" title="Marcar como pago" class="btn-check-pago">
              <i class="fas fa-check"></i>
            </button>
          </form>
        </div>
      </div>
      {% endfor %} 
      {% if not proximas_contas %}
      <p class="msg-vazio">Tudo em dia! üôå</p>
      {% endif %}
    </div>

    {% if proximas_contas|length > 1 %}
    <div class="carrossel-controls">
      <button onclick="mudarConta(-1)" class="btn-carrossel" title="Conta Anterior">
        <i class="fas fa-chevron-left"></i>
      </button>
      <span id="contador-carrossel" class="contador-carrossel">
        1 / {{ proximas_contas|length }}
      </span>
      <button onclick="mudarConta(1)" class="btn-carrossel" title="Pr√≥xima Conta">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    {% endif %}
  </div>

  <div class="card-atalho">
    <p class="atalho-texto">Registrar novo gasto?</p>
    <a href="/novo_lancamento" class="btn-principal">+ Nova Transa√ß√£o</a>
  </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow border-0" style="border-radius: 15px;">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie"></i> Vis√£o Geral de Gastos e Metas
                </h6>
                <a href="{{ url_for('configurar_metas') }}" class="btn btn-sm btn-outline-primary" style="border-radius: 20px;">
                    Configurar Limites
                </a>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-7 ps-md-4">
                        <div class="text-start mb-3">
                            <span class="text-muted small text-uppercase font-weight-bold">Progresso das Metas</span>
                        </div>
                        <div class="metas-container" style="max-height: 250px; overflow-y: auto;">
                            {% if metas %}
                                {% for meta in metas %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span class="font-weight-bold text-dark">{{ meta.categoria_nome }}</span>
                                        <span class="text-muted">{{ (meta.percentual)|round|int }}% usado</span>
                                    </div>
                                    <div class="progress" style="height: 12px; border-radius: 6px;">
                                        <div class="progress-bar {{ meta.cor_barra }} progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             style="width: {{ meta.percentual }}%"></div>
                                    </div>
                                    <div class="text-end mt-1" style="font-size: 0.75rem;">
                                        <strong>{{ meta.total_gasto | moeda }}</strong> / {{ meta.valor_limite | moeda }}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-4">
                                    <p class="text-muted small">Nenhuma meta definida para este m√™s.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-5 border-end">
                        <div class="text-center mb-2">
                            <span class="text-muted small text-uppercase font-weight-bold">Distribui√ß√£o Mensal</span>
                        </div>
                        <div style="height: 220px;">
                            <canvas id="graficoCategorias"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="divisor-filtro">

<div class="card-grafico">
    <h3 class="card-grafico-title">Por Pagamento</h3>
    <div class="lista-pagamentos-container">
        {% if labels_metodos and labels_metodos|length > 0 %}
            <ul class="lista-pagamentos">
                {% for i in range(labels_metodos|length) %}
                    <li class="item-pagamento">
                        <div class="pagamento-info">
                            <i class="fas fa-check-circle text-success" style="font-size: 0.8rem;"></i>
                            <span class="metodo-nome">{{ labels_metodos[i] }}</span>
                        </div>
                        <span class="metodo-valor">
                            {{ "R$ {:,.2f}".format(valores_metodos[i]).replace(',', 'v').replace('.', ',').replace('v', '.') }}
                        </span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="chart-vazio">
                <p>Nenhuma transa√ß√£o este m√™s.</p>
            </div>
        {% endif %}
    </div>
</div>

<hr class="divisor-filtro">

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Comparativo: Entradas, Sa√≠das e Investimentos (Ano {{ datetime_now.year }})</h5>
    </div>
    <div class="card-body">
        <div style="height: 300px;">
            <canvas id="canvasFluxoCaixa"></canvas>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Configura√ß√µes Globais
    const formatarMoeda = (valor) => {
        return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    // 2. Captura das vari√°veis
    const labelsCategorias = {{ labels|tojson|safe if labels else '[]' }};
    const valoresCategorias = {{ valores|tojson|safe if valores else '[]' }};
    const coresCategorias = {{ cores|tojson|safe if cores else '[]' }};
    
    const dadosReceitasAnuais = {{ receitas_anuais | tojson | safe if receitas_anuais else '[0,0,0,0,0,0,0,0,0,0,0,0]' }};
    const dadosDespesasAnuais = {{ despesas_anuais | tojson | safe if despesas_anuais else '[0,0,0,0,0,0,0,0,0,0,0,0]' }};
    const dadosInvestAnuais = {{ investimentos_anuais | tojson | safe if investimentos_anuais else '[0,0,0,0,0,0,0,0,0,0,0,0]' }};

    // 3. Gr√°fico de Fluxo de Caixa Anual
    const ctxFluxoAnual = document.getElementById('canvasFluxoCaixa');
    if (ctxFluxoAnual) {
        new Chart(ctxFluxoAnual, {
            type: 'bar',
            data: {
                labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
                datasets: [
                    {
                        label: 'Entradas (Receitas)',
                        data: dadosReceitasAnuais,
                        backgroundColor: 'rgba(39, 174, 96, 0.7)',
                        borderColor: '#27ae60',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Sa√≠das (Despesas)',
                        data: dadosDespesasAnuais,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        borderRadius: 4
                    }, // <-- ADICIONADA V√çRGULA AQUI PARA CORRIGIR O ERRO
                    {
                        label: 'Investimentos (Patrim√¥nio)',
                        data: dadosInvestAnuais,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: '#3498db',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${formatarMoeda(context.raw)}`
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: (v) => formatarMoeda(v) } }
                }
            }
        });
    }

    // 4. Gr√°fico de Categorias (Pizza)
    const ctxCategorias = document.getElementById('graficoCategorias');
    if (ctxCategorias && labelsCategorias.length > 0) {
        new Chart(ctxCategorias, {
            type: 'doughnut',
            data: {
                labels: labelsCategorias,
                datasets: [{
                    data: valoresCategorias,
                    backgroundColor: coresCategorias,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "70%",
                plugins: {
                    legend: { position: "bottom" },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.label}: ${formatarMoeda(context.raw)}`
                        }
                    }
                }
            }
        });
    }
    // 5. Gr√°fico de Efici√™ncia
    const ctxEficiencia = document.getElementById('graficoEficiencia');
    if (ctxEficiencia) {
        const totalDespesas = {{ total_despesas | tojson | safe if total_despesas else 0 }};
        const totalInvest = {{ total_investimentos | tojson | safe if total_investimentos else 0 }};

        new Chart(ctxEficiencia, {
            type: 'doughnut',
            data: {
                labels: ['Gastos Reais', 'Investimentos'],
                datasets: [{
                    data: [totalDespesas, totalInvest],
                    backgroundColor: ['#e74a3b', '#4e73df'],
                    hoverOffset: 4,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '80%',
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw || 0;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                return label + ': ' + (typeof formatarMoeda === 'function' ? formatarMoeda(value) : 'R$ ' + value.toFixed(2)) + ' (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });
    }

    // 6. L√≥gica do Carrossel
    let indiceAtual = 0;
    const listaDeContas = document.querySelectorAll(".item-conta");
    const labelContador = document.getElementById("contador-carrossel");

    window.mudarConta = function(direcao) {
        if (listaDeContas.length <= 1) return;
        listaDeContas[indiceAtual].style.display = "none";
        indiceAtual = (indiceAtual + direcao + listaDeContas.length) % listaDeContas.length;
        listaDeContas[indiceAtual].style.display = "block";
        if (labelContador) labelContador.innerText = (indiceAtual + 1) + " / " + listaDeContas.length;
    };

document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('graficoDespesas').getContext('2d');
    
    // Pegando os dados passados pelo Flask (convertendo para JSON)
    const labels = {{ grafico_labels | tojson }};
    const valores = {{ grafico_valores | tojson }};

    new Chart(ctx, {
        type: 'doughnut', // 'doughnut' fica mais moderno que 'pie'
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
                    '#858796', '#5a5c69', '#f8f9fc', '#4e73df'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { boxWidth: 12 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            return `${label}: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                        }
                    }
                }
            },
            cutout: '70%' // Deixa o gr√°fico estilo "rosca"
        }
    });
});
</script>
{% endblock %}
