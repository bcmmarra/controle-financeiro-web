{% extends 'base.html' %}

{% block conteudo %}
<h2 class="page-title">Extrato de Transações</h2>

<div class="filtros-container">
    <form method="GET" action="/listagem" class="filtros-form">
        <div class="filtro-grupo">
            <label>Busca</label>
            <input type="text" name="busca" value="{{ request.args.get('busca', '') }}" placeholder="Descrição...">
        </div>

        <div class="filter-item">
            <label>Mês Específico:</label>
            <input type="month" name="mes_filtro" id="id_mes_filtro" class="form-control" 
                value="{{ mes_ano_input }}" 
                onchange="document.getElementById('id_ano_filtro').value = '';">
        </div>

        <div class="filtro-grupo">
            <label>Ver Ano Todo</label>
            <select name="ano_filtro" id="id_ano_filtro" class="form-control"
                    onchange="document.getElementById('id_mes_filtro').value = '';">
                <option value="">Selecione o Ano</option>
                {% for ano in anos %}
                    <option value="{{ ano }}" {{ 'selected' if ano|string == ano_selecionado|string else '' }}>
                        {{ ano }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Método</label>
            <select name="metodo">
                <option value="">Todos</option>
                <option value="Dinheiro" {% if request.args.get('metodo')=='Dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="Cartão de Crédito" {% if request.args.get('metodo')=='Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                <option value="Pix" {% if request.args.get('metodo')=='Pix' %}selected{% endif %}>Pix</option>
                <option value="Boleto" {% if request.args.get('metodo')=='Boleto' %}selected{% endif %}>Boleto</option>
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Status</label>
            <select name="status">
                <option value="">Todos</option>
                <option value="1" {% if request.args.get('status')=='1' %}selected{% endif %}>Pago</option>
                <option value="0" {% if request.args.get('status')=='0' %}selected{% endif %}>Pendente</option>
            </select>
        </div>

        <div class="filtros-acoes">
            <button type="submit" class="btn-filtrar">Filtrar</button>
            <a href="/listagem" class="btn-limpar">Limpar</a>
        </div>
    </form>
</div>

<hr class="divisor-filtro">

<div class="row mb-2">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #1cc88a; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Receitas (Entradas)</div>
                    <div id="card-receitas" class="h5 mb-0 font-weight-bold">{{ total_receitas | moeda }}</div>
                </div>
                <i class="fas fa-hand-holding-usd fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #5a5c69; background-color: #f8f9fc; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-muted" style="font-size: 0.8rem; line-height: 1;">Total de Despesas</div>
                    <div id="card-despesas" class="h6 mb-0 font-weight-bold">{{ total_despesas | moeda }}</div>
                </div>
                <i class="fas fa-file-invoice-dollar text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #4e73df; background-color: #f8fbff; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-primary" style="font-size: 0.8rem; line-height: 1;">Saldo Projetado</div>
                    <div id="card-saldo" class="h5 mb-0 font-weight-bold {{ 'text-danger' if saldo_atual < 0 else 'text-dark' }}">
                        {{ saldo_atual | moeda }}
                    </div>
                </div>
                <i class="fas fa-wallet fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #28a745; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Total Pago</div>
                    <div id="card-pago" class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pago | moeda }}</div>
                </div>
                <i class="fas fa-check-double text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #fd7e14; background-color: #fffaf5; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-warning" style="font-size: 0.8rem; line-height: 1;">Aguardando Pagamento</div>
                    <div id="card-pendente" class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pendente | moeda }}</div>
                </div>
                <i class="fas fa-clock text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 no-print">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 bg-gradient-blue text-white" style="background: linear-gradient(45deg, #2980b9, #3498db); border-radius: 12px; height: 100%; min-height: 140px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-white-50 small mb-1 text-uppercase font-weight-bold">Aporte Mensal</p>
                        <div id="card-aporte" class="h6 mb-0 font-weight-bold">{{ total_investimentos | moeda }}</div>
                    </div>
                    <div class="rounded-circle p-2" style="background: rgba(255,255,255,0.2);">
                        <i class="fas fa-chart-line fa-lg"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2); border-radius: 10px;">
                        <div id="barra-aporte" class="progress-bar bg-white" role="progressbar" 
                             style="width: {{ (total_investimentos / total_receitas * 100) if total_receitas > 0 else 0 }}%; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div id="container-saude" class="card shadow py-1" style="border-left: 10px solid {{ '#e74a3b' if saldo_atual < 0 else ('#f6e05e' if percentual_gasto > 80 else '#1cc88a') }}; background-color: {{ '#fff5f5' if saldo_atual < 0 else ('#fffdf0' if percentual_gasto > 80 else '#f1fcf4') }}; border-radius: 12px; height: 100%;">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div style="flex-grow: 1;">
                    <div class="text-sm font-weight-bold text-info text-uppercase mb-2">
                        <i class="fas fa-shield-alt"></i> Diagnóstico da Saúde Financeira
                    </div>
                    <div class="d-flex align-items-center">
                        <span id="txt-saude" class="h3 mb-0 font-weight-bold mr-3 
                            {{ 'text-danger' if saldo_atual < 0 else ('text-warning' if percentual_gasto > 80 else 'text-success') }}">
                            {{ status_financeiro }}
                        </span>
                    </div>
                    <p id="txt-dica" class="text-muted mt-2 mb-0" style="font-size: 0.95rem;">
                        <strong>Dica:</strong> {{ sugestao }}
                    </p>
                </div>
                <div class="d-none d-md-block ml-4">
                    <i id="icone-saude" class="fas 
                        {{ 'fa-exclamation-triangle text-danger' if saldo_atual < 0 else ('fa-exclamation-circle text-warning' if percentual_gasto > 80 else 'fa-check-circle text-success') }} 
                        fa-3x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="divisor-filtro">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="titulo-pagina">Extrato de Transações</h2>
    <a href="{{ url_for('novo_lancamento') }}" class="btn btn-success shadow-sm">
        <i class="fas fa-plus-circle"></i> Novo Lançamento
    </a>
</div>

<form id="form-listagem" method="POST">
    
    <div id="barraAcoesMassa" class="alert alert-secondary d-none d-flex justify-content-between align-items-center p-2 mb-3 shadow-sm sticky-top" style="top: 10px; z-index: 1020;">
        <div>
            <i class="fas fa-check-double me-2 text-primary"></i>
            <strong><span id="contadorSelecionados">0</span></strong> itens selecionados
        </div>
        
        <div class="d-flex gap-2">
            <select name="id_destino" class="form-select form-select-sm" style="width: 200px;">
                <option value="">Mover para categoria...</option>
                {% for cat in categorias %}
                    <option value="{{ cat.id }}">{{ cat.nome }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" formaction="{{ url_for('mover_transacoes_selecionadas') }}" class="btn btn-primary btn-sm">
                Mover
            </button>

            <button type="button" class="btn btn-danger btn-sm" onclick="confirmarExclusaoMassa()">
                <i class="fas fa-trash"></i> Excluir
            </button>
        </div>
    </div>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle bg-white">
            <thead class="thead-light">
                <tr>
                    <th><input type="checkbox" id="selecionarTodos" class="form-check-input"></th>
                    <th style="width: 120px;">DATA</th>
                    <th>DESCRIÇÃO</th>
                    <th>CATEGORIA</th>
                    <th>MÉTODO</th>
                    <th>VALOR</th>
                    <th>STATUS</th>
                    <th class="text-center" style="width: 100px;">AÇÕES</th>
                </tr>
            </thead>
            <tbody>
                {% set controle = namespace(ultimo_tipo=None) %}
                {% for t in transacoes %}
                    
                    {% if t.tipo != controle.ultimo_tipo %}
                        <tr class="secao-divisor bg-light">
                            <td colspan="8" class="py-2 px-3 border-left-{{ 'success' if t.tipo == 'receita' else 'danger' if t.tipo == 'despesa' else 'primary' }}">
                                <div class="d-flex align-items-center">
                                    <strong class="text-{{ 'success' if t.tipo == 'receita' else 'danger' if t.tipo == 'despesa' else 'primary' }} small uppercase">
                                        <i class="fas fa-{{ 'arrow-up' if t.tipo == 'receita' else 'arrow-down' if t.tipo == 'despesa' else 'chart-line' }} mr-2"></i> 
                                        {{ t.tipo|upper }}S
                                    </strong>
                                    <div class="flex-grow-1 ml-3" style="height: 1px; background: #dee2e6;"></div>
                                </div>
                            </td>
                        </tr>
                        {% set controle.ultimo_tipo = t.tipo %}
                    {% endif %}

                    <tr>
                        <td>
                            <input type="checkbox" name="transacoes_selecionadas" value="{{ t.id }}" class="form-check-input check-item">
                        </td>
                        <td class="text-nowrap">{{ t.data_transacao.strftime('%d/%m/%Y') }}</td>
                        <td class="font-weight-bold">{{ t.descricao }}</td>
                        <td>
                            <span class="badge badge-pill text-white" style="background-color: {{ t.categoria_cor if t.categoria_cor else '#6c757d' }}; min-width: 80px; padding: 5px 12px;">
                                {{ t.categoria_nome if t.categoria_nome else 'Geral' }}
                            </span>
                        </td>
                        <td><small class="text-muted">{{ t.metodo if t.metodo and t.metodo != 'None' else '---' }}</small></td>
                        <td class="font-weight-bold text-{{ 'success' if t.tipo == 'receita' else 'danger' }}">
                             R$ {{ "{:,.2f}".format(t.valor_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                        </td>
                        <td class="status-col">
                        {% if t.tipo == 'receita' %}
                            <div class="status-wrapper text-success">
                                <i class="fas fa-check-circle status-icon"></i>
                                <span class="font-weight-bold">Recebido</span>
                            </div>
                        {% else %}
                            <form action="{{ url_for('alternar_pagamento', id=t.id) }}" method="post" class="form-status" style="cursor:pointer;">
                                <div class="status-container status-wrapper">
                                    {% if t.pago == 1 %}
                                        <div class="text-success">
                                            <i class="fas fa-check-circle status-icon"></i>
                                            <span class="font-weight-bold">Pago</span>
                                        </div>
                                    {% else %}
                                        <div class="text-warning">
                                            <i class="far fa-clock status-icon"></i>
                                            <span class="font-weight-bold">Pendente</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </form>
                        {% endif %}
                        </td>
                            <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{{ url_for('editar', id=t.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="confirmarExclusao({{ t.id }}, {{ 'true' if t.is_recorrente or t.is_parcelado else 'false' }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
<br>

<div class="export-container no-print">
    <span class="export-label">
        Exportar - <strong>({{ mes_atual_pt }}):</strong>
    </span>
    
    <a href="{{ url_for('exportar_excel', **request.args) }}" class="btn-export btn-excel">
        <i class="fas fa-file-excel"></i> Excel
    </a>
    
    <button onclick="window.print()" class="btn-export btn-pdf" style="border: none; cursor: pointer;">
        <i class="fas fa-file-pdf"></i> PDF (Imprimir)
    </button>
</div>

<div id="loadingOverlay" class="d-none" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <div class="spinner-border text-primary" style="width: 3.5rem; height: 3.5rem;" role="status"></div>
    <h4 class="mt-4 text-primary font-weight-bold">Descomplica MyFinance</h4>
    <p class="text-dark">Lendo seu extrato bancário, um momento...</p>
</div>

<div class="card mb-4 border-primary shadow-sm">
    <div class="card-body">
        <h5 class="card-title text-primary"><i class="fas fa-file-import"></i> Importar Extrato Bancário</h5>
        
        <form id="formImportarOFX" action="{{ url_for('importar_ofx') }}" method="post" enctype="multipart/form-data" class="row g-3" onsubmit="mostrarLoading()">
            <div class="col-md-8">
                <input type="file" name="arquivo_ofx" class="form-control" accept=".ofx" required id="inputOFX">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-upload"></i> Enviar Arquivo
                </button>
            </div>
        </form>
        
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> Aceita arquivos .OFX (BB, Caixa, Bradesco, PicPay etc).
            </small>
        </div>
    </div>
</div>


<div class="modal fade" id="modalExcluir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formExcluir" method="POST">
                <div class="modal-body">
                    <p id="textoExclusao">Tem certeza que deseja excluir este lançamento?</p>
                    
                    <div id="opcoesGrupoExcluir" style="display: none;" class="mt-3 p-3 bg-light rounded border">
                        <label class="form-label font-weight-bold">Este lançamento faz parte de um grupo:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo_exclusao" id="exc_simples" value="somente_esta" checked>
                            <label class="form-check-label" for="exc_simples">Excluir somente este mês</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipo_exclusao" id="exc_grupo" value="esta_e_proximas">
                            <label class="form-check-label" for="exc_grupo">Excluir este e todos os futuros</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Exclusão</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 1. Utilitários
const formatarParaReal = (valor) => {
    const numero = parseFloat(valor) || 0;
    return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
};

// 2. Lógica de Seleção em Massa
document.addEventListener('DOMContentLoaded', function() {
    const checkTodos = document.getElementById('selecionarTodos');
    const barraAcoes = document.getElementById('barraAcoesMassa');
    const contador = document.getElementById('contadorSelecionados');

    function atualizarBarra() {
        const todosChecks = document.querySelectorAll('.check-item');
        const selecionados = document.querySelectorAll('.check-item:checked');
        
        if (selecionados.length > 0) {
            barraAcoes.classList.remove('d-none');
            barraAcoes.classList.add('d-flex');
            contador.innerText = selecionados.length;
        } else {
            barraAcoes.classList.add('d-none');
            barraAcoes.classList.remove('d-flex');
        }

        // Sincroniza o "Selecionar Todos" se o usuário desmarcar um item manualmente
        if (checkTodos) {
            checkTodos.checked = (selecionados.length === todosChecks.length && todosChecks.length > 0);
        }
    }

    // Evento para o checkbox do topo (Selecionar Todos)
    if (checkTodos) {
        checkTodos.addEventListener('change', function() {
            document.querySelectorAll('.check-item').forEach(c => {
                c.checked = checkTodos.checked;
            });
            atualizarBarra();
        });
    }

    // Evento para os checkboxes da tabela (Delegação de evento para performance)
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('check-item')) {
            atualizarBarra();
        }
    });

    // Lógica de Auto-seleção via URL (Ex: após importar OFX)
    const urlParams = new URLSearchParams(window.location.search);
    const autoSelectIds = urlParams.get('auto_select');
    if (autoSelectIds) {
        autoSelectIds.split(',').forEach(id => {
            const cb = document.querySelector(`.check-item[value="${id}"]`);
            if (cb) {
                cb.checked = true;
                cb.closest('tr').classList.add('table-warning');
            }
        });
        atualizarBarra();
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

// 3. Função de Exclusão em Massa
function confirmarExclusaoMassa() {
    // 1. Pegamos todos os marcados
    const selecionados = document.querySelectorAll('.check-item:checked');
    
    if (selecionados.length === 0) {
        alert("Selecione pelo menos um item.");
        return;
    }

    // 2. Confirmação amigável
    if (confirm(`Você selecionou ${selecionados.length} itens. Deseja excluí-los permanentemente?`)) {
        const form = document.getElementById('form-listagem');
        
        // 3. Muda o destino do formulário para a rota de exclusão
        form.action = "{{ url_for('excluir_massa') }}";
        
        // 4. Envia o formulário
        form.submit();
    }
}

// 4. Modal de Exclusão Individual (Recorrente)
function confirmarExclusao(id, isGrupo) {
    const form = document.getElementById('formExcluir');
    form.action = "/excluir_transacao/" + id;

    const divOpcoes = document.getElementById('opcoesGrupoExcluir');
    const texto = document.getElementById('textoExclusao');

    if (isGrupo) {
        if(divOpcoes) divOpcoes.style.display = "block";
        texto.innerText = "Este lançamento é recorrente. Como deseja proceder?";
    } else {
        if(divOpcoes) divOpcoes.style.display = "none";
        texto.innerText = "Tem certeza que deseja excluir este lançamento?";
    }

    const modalEl = document.getElementById('modalExcluir');
    if (modalEl) {
        const myModal = new bootstrap.Modal(modalEl);
        myModal.show();
    }
}
</script>

<style>
/* ... (Seus estilos permanecem exatamente iguais) ... */
.status-col { min-width: 140px; vertical-align: middle !important; }
.status-wrapper { display: flex; align-items: center; gap: 8px; justify-content: flex-start; }
.status-icon { width: 18px; text-align: center; font-size: 1.1rem; }
.form-status:hover { opacity: 0.8; transform: scale(1.02); transition: 0.2s; }
.btn-export { display: inline-flex; align-items: center; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; gap: 8px; transition: 0.3s; }
.btn-excel { background-color: #217346; color: white !important; }
.btn-pdf { background-color: #d32f2f; color: white !important; }
.btn-export:hover { opacity: 0.8; transform: translateY(-1px); }

@media print {
    .sidebar, .navbar, .btn-export, .filtros, .no-print, .btn, footer, #id_ano_filtro, #id_mes_filtro, .print,.filtros-form, .text-muted, .main-nav { display: none !important; }
    body { background-color: white !important; margin: 0; padding: 0; }
    .row { display: flex !important; flex-direction: row !important; justify-content: space-between !important; margin-bottom: 20px !important; }
    .col-md-4 { width: 32% !important; }
    .card { border: 1px solid #ddd !important; padding: 10px !important; box-shadow: none !important; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .table { width: 100% !important; border-collapse: collapse !important; }
    .table th { background-color: #f8f9fa !important; border: 1px solid #ddd !important; }
    .table td { border: 1px solid #ddd !important; }
}
</style>

{% endblock %}