{% extends 'base.html' %}

{% block conteudo %}
<h2 class="page-title">Extrato de Transações</h2>

<div class="card-filtro-container">
    <form method="GET" action="/listagem" class="form-filtros">
        <div class="filtro-group busca">
            <label>Busca</label>
            <input type="text" name="busca" value="{{ request.args.get('busca', '') }}" placeholder="Descrição...">
        </div>

        <div class="filtro-group">
            <label>Mês Específico</label>
            <input type="month" name="mes_filtro" id="id_mes_filtro"
                value="{{ mes_atual if mes_atual|length == 7 else '' }}"
                onchange="if(this.value) document.getElementById('id_ano_filtro').value = '';">
        </div>
        
        <div class="filtro-group">
            <label>Ver Ano Todo</label>
            <select name="ano_filtro" id="id_ano_filtro"
                onchange="if(this.value) document.getElementById('id_mes_filtro').value = '';">
                <option value="">Selecione...</option>
                {% for ano in range(2023, 2031) %}
                <option value="{{ ano }}" {% if mes_atual==ano|string %}selected{% endif %}>{{ ano }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filtro-group">
            <label>Método</label>
            <select name="metodo">
                <option value="">Todos</option>
                <option value="Dinheiro" {% if request.args.get('metodo')=='Dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="Cartão de Crédito" {% if request.args.get('metodo')=='Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                <option value="Pix" {% if request.args.get('metodo')=='Pix' %}selected{% endif %}>Pix</option>
                <option value="Boleto" {% if request.args.get('metodo')=='Boleto' %}selected{% endif %}>Boleto</option>
            </select>
        </div>

        <div class="filtro-group">
            <label>Status</label>
            <select name="status">
                <option value="">Todos</option>
                <option value="1" {% if request.args.get('status')=='1' %}selected{% endif %}>Pago</option>
                <option value="0" {% if request.args.get('status')=='0' %}selected{% endif %}>Pendente</option>
            </select>
        </div>

        <div class="filtro-actions">
            <button type="submit" class="btn-filtrar">Filtrar</button>
            <a href="/listagem" class="btn-limpar">Limpar</a>
        </div>
    </form>

    <hr class="divisor-filtro">

    <div class="grid-resumo-extrato">
        <div class="mini-card mini-total">
            <span class="mini-label">Gasto do Mês</span>
            <h2 id="card-gasto" class="mini-valor">R$ {{ "%.2f"|format(total_geral) }}</h2>
        </div>

        <div class="mini-card mini-pago">
            <span class="mini-label">Valor Pago</span>
            <h2 id="card-pago" class="mini-valor">R$ {{ "%.2f"|format(total_pago) }}</h2>
        </div>

        <div class="mini-card mini-pendente">
            <span class="mini-label">Valor Pendente</span>
            <h2 id="card-pendente" class="mini-valor">R$ {{ "%.2f"|format(total_pendente) }}</h2>
        </div>
    </div>
</div>

<div class="export-container">
    <span class="export-label">
        Exportar <strong>{{ mes_atual_pt }}</strong>:
    </span>
    <a href="{{ url_for('exportar_excel', mes=datetime_now.month, ano=datetime_now.year) }}" class="btn-export btn-excel">
        <i class="fas fa-file-excel"></i> Excel
    </a>
    <a href="#" onclick="window.print(); return false;" class="btn-export btn-pdf">
        <i class="fas fa-file-pdf"></i> PDF (Imprimir)
    </a>
</div>

<div class="tabela-wrapper">
    <table class="tabela-extrato">
        <thead>
            <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Método</th>
                <th>Valor</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transacoes %}
            <tr>
                <td>{{ t.data_transacao.strftime('%d/%m/%Y') }}</td>
                <td>
                    {{ t.descricao }}
                    {% if t.is_parcelado %}
                    <span class="parcela-tag">({{ t.parcela_atual }}/{{ t.numero_parcelas }})</span>
                    {% endif %}
                </td>
                <td><span class="categoria-badge">{{ t.categoria_nome }}</span></td>
                <td>{{ t.metodo_pagamento }}</td>
                <td class="valor-celula">R$ {{ "%.2f"|format(t.valor_total) }}</td>
                <td class="status-celula">
                    <form class="form-status" action="{{ url_for('alternar_pagamento', id=t.id) }}" method="POST">
                        <button type="submit" class="btn-status-toggle" title="Alterar status">
                            <div class="status-container">
                                {% if t.pago %}
                                <span class="status-pago">● Pago</span>
                                {% else %}
                                <span class="status-pendente">○ Pendente</span>
                                {% endif %}
                            </div>
                        </button>
                    </form>
                </td>
                <td class="acoes-celula">
                    <a href="/editar/{{ t.id }}" class="btn-edit" title="Editar"><i class="fas fa-edit"></i></a>
                    <a href="/deletar/{{ t.id }}" class="btn-delete" title="Excluir" onclick="return confirm('Deseja realmente excluir?')"><i class="fas fa-trash"></i></a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="tabela-vazia">Nenhuma transação encontrada para este período.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Script Ajax mantido aqui por depender de IDs do DOM
document.querySelectorAll('.form-status').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault(); 
        const url = this.action;
        const container = this.querySelector('.status-container');

        fetch(url, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                if (container.innerText.includes('Pago')) {
                    container.innerHTML = '<span class="status-pendente">○ Pendente</span>';
                } else {
                    container.innerHTML = '<span class="status-pago">● Pago</span>';
                }
                document.getElementById('card-gasto').innerText = 'R$ ' + data.novo_total.toFixed(2);
                document.getElementById('card-pago').innerText = 'R$ ' + data.novo_pago.toFixed(2);
                document.getElementById('card-pendente').innerText = 'R$ ' + data.novo_pendente.toFixed(2);
            }
        })
        .catch(error => console.error('Erro:', error));
    });
});
</script>
{% endblock %}