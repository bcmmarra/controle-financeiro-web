{% extends 'base.html' %}

{% block conteudo %}
<h2 class="page-title">Extrato de Transações</h2>

<div class="filtros-container">
    <form method="GET" action="/listagem" class="filtros-form">
        <div class="filtro-grupo">
            <label>Busca</label>
            <input type="text" name="busca" value="{{ request.args.get('busca', '') }}" placeholder="Descrição...">
        </div>

        <div class="filter-item">
            <label>Mês Específico:</label>
            <input type="month" name="mes_filtro" id="id_mes_filtro" class="form-control" 
                value="{{ mes_ano_input }}" 
                onchange="document.getElementById('id_ano_filtro').value = '';">
        </div>

        <div class="filtro-grupo">
            <label>Ver Ano Todo</label>
            <select name="ano_filtro" id="id_ano_filtro" class="form-control"
                    onchange="document.getElementById('id_mes_filtro').value = '';">
                <option value="">Selecione o Ano</option>
                {% for ano in anos %}
                    <option value="{{ ano }}" {{ 'selected' if ano|string == ano_selecionado|string else '' }}>
                        {{ ano }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Método</label>
            <select name="metodo">
                <option value="">Todos</option>
                <option value="Dinheiro" {% if request.args.get('metodo')=='Dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="Cartão de Crédito" {% if request.args.get('metodo')=='Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                <option value="Pix" {% if request.args.get('metodo')=='Pix' %}selected{% endif %}>Pix</option>
                <option value="Boleto" {% if request.args.get('metodo')=='Boleto' %}selected{% endif %}>Boleto</option>
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Status</label>
            <select name="status">
                <option value="">Todos</option>
                <option value="1" {% if request.args.get('status')=='1' %}selected{% endif %}>Pago</option>
                <option value="0" {% if request.args.get('status')=='0' %}selected{% endif %}>Pendente</option>
            </select>
        </div>

        <div class="filtros-acoes">
            <button type="submit" class="btn-filtrar">Filtrar</button>
            <a href="/listagem" class="btn-limpar">Limpar</a>
        </div>
    </form>
<hr class="divisor-filtro">

<div class="row mb-2">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #1cc88a; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Receitas (Entradas)</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_receitas | moeda }}</div>
                </div>
                <i class="fas fa-hand-holding-usd fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
        <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #5a5c69; background-color: #f8f9fc; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-muted" style="font-size: 0.8rem; line-height: 1;">Total de Despesas</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_geral | moeda }}</div>
                </div>
                <i class="fas fa-file-invoice-dollar text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #4e73df; background-color: #f8fbff; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-primary" style="font-size: 0.8rem; line-height: 1;">Saldo Projetado</div>
                    <div class="h5 mb-0 font-weight-bold {{ 'text-danger' if saldo_atual < 0 else 'text-gray-800' }}">
                        {{ saldo_atual | moeda }}
                    </div>
                </div>
                <i class="fas fa-wallet fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #28a745; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Total Pago</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pago | moeda }}</div>
                </div>
                <i class="fas fa-check-double text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #fd7e14; background-color: #fffaf5; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-warning" style="font-size: 0.8rem; line-height: 1;">Aguardando Pagamento</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pendente | moeda }}</div>
                </div>
                <i class="fas fa-clock text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4 no-print">
    <div class="col-12">
        <div class="card shadow py-1" style="border-left: 10px solid {{ '#e74a3b' if saldo_atual < 0 else '#1cc88a' }}; background-color: {{ '#fff5f5' if saldo_atual < 0 else '#f1fcf4' }}; border-radius: 12px;">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div style="flex-grow: 1;">
                    <div class="text-sm font-weight-bold text-info text-uppercase mb-2">
                        <i class="fas fa-shield-alt"></i> Diagnóstico da Saúde Financeira
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="h3 mb-0 font-weight-bold mr-3 {{ 'text-danger' if saldo_atual < 0 else 'text-success' }}">
                            {{ status_financeiro }}
                        </span>
                        <span class="badge badge-pill badge-dark" style="padding: 6px 10px;">{{ mes_atual_pt }}</span>
                    </div>
                    <p class="text-muted mt-2 mb-0" style="font-size: 0.95rem;">
                        <strong>Dica do Sistema:</strong> {{ sugestao }}
                    </p>
                </div>
                <div class="d-none d-md-block ml-4">
                    <i class="fas {{ 'fa-exclamation-triangle text-danger' if saldo_atual < 0 else 'fa-check-circle text-success' }} fa-4x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="divisor-filtro">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="titulo-pagina">Extrato de Transações</h2>
        <a href="{{ url_for('novo_lancamento') }}" class="btn btn-success shadow-sm">
            <i class="fas fa-plus-circle"></i> Novo Lançamento
        </a>
    </div>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle bg-white">
            <thead class="thead-light">
                <tr>
                    <th style="width: 120px;">DATA</th>
                    <th>DESCRIÇÃO</th>
                    <th>CATEGORIA</th>
                    <th>MÉTODO</th>
                    <th>VALOR</th>
                    <th>STATUS</th>
                    <th class="text-center" style="width: 100px;">AÇÕES</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transacoes %}
                <tr>
                    <td class="text-nowrap">{{ t.data_transacao.strftime('%d/%m/%Y') }}</td>
                    <td class="font-weight-bold">{{ t.descricao }}</td>
                    <td>
                        <span class="badge badge-pill text-white" 
                            style="background-color: {{ t.categoria_cor if t.categoria_cor else '#6c757d' }}; 
                                    min-width: 80px; padding: 5px 12px; font-weight: 500; shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            {{ t.categoria_nome if t.categoria_nome else 'Geral' }}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted font-italic">
                            {{ t.metodo if t.metodo and t.metodo != 'None' else '---' }}
                        </small>
                    </td>
                    <td class="font-weight-bold" 
                        style="color: {% if t.tipo == 'receita' %}#28a745{% elif t.tipo == 'investimento' %}{{ t.categoria_cor }}{% else %}#dc3545{% endif %};">
                        {% if t.tipo == 'receita' %}+{% else %}-{% endif %} 
                        R$ {{ "{:,.2f}".format(t.valor_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                    </td>
                    <td class="status-col">
                        {% if t.tipo == 'receita' %}
                            <div class="status-wrapper text-success">
                                <i class="fas fa-check-circle status-icon"></i>
                                <span class="font-weight-bold">Recebido</span>
                            </div>
                        {% else %}
                            <form action="{{ url_for('alternar_pagamento', id=t.id) }}" method="post" class="form-status" style="cursor:pointer;">
                                <div class="status-container status-wrapper">
                                    {% if t.pago == 1 %}
                                        <div class="text-success">
                                            <i class="fas fa-check-circle status-icon"></i>
                                            <span class="font-weight-bold">Pago</span>
                                        </div>
                                    {% else %}
                                        <div class="text-warning">
                                            <i class="far fa-clock status-icon"></i>
                                            <span class="font-weight-bold">Pendente</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </form>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center align-items-center">
                            <a href="{{ url_for('editar', id=t.id) }}" class="btn btn-sm text-primary p-1 mr-3" title="Editar">
                                <i class="fas fa-edit fa-lg"></i>
                            </a>
                            
                            <form action="{{ url_for('excluir', id=t.id) }}" method="GET" style="display:inline;">
                                <button type="submit" class="btn btn-sm text-danger p-1" style="background:none; border:none;" onclick="return confirm('Excluir transação?')">
                                    <i class="fas fa-trash-alt fa-lg"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
<br>
    <div class="export-container no-print">
        <span class="export-label">
            Exportar <strong>{{ rotulo_exportar }}</strong>:
        </span>
        
        <a href="{{ url_for('exportar_excel', **request.args) }}" class="btn-export btn-excel">
            <i class="fas fa-file-excel"></i> Excel
        </a>
        
        <button onclick="window.print()" class="btn-export btn-pdf" style="border: none; cursor: pointer;">
            <i class="fas fa-file-pdf"></i> PDF (Imprimir)
        </button>
    </div>

<script>
// 1. Função de formatação definida globalmente para o script
const formatarParaReal = (valor) => {
    // Garante que o valor seja um número antes de formatar
    const numero = parseFloat(valor) || 0;
    return numero.toLocaleString('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    });
};

document.querySelectorAll('.form-status').forEach(form => {
    form.addEventListener('click', function() {
        const url = this.action;
        const container = this.querySelector('.status-container');

        fetch(url, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                if (container.innerHTML.includes('fa-check-circle')) {
                    // Muda para Pendente mantendo a estrutura de alinhamento
                    container.innerHTML = `
                        <div class="text-warning">
                            <i class="far fa-clock status-icon"></i>
                            <span class="font-weight-bold">Pendente</span>
                        </div>`;
                } else {
                    // Muda para Pago mantendo a estrutura de alinhamento
                    container.innerHTML = `
                        <div class="text-success">
                            <i class="fas fa-check-circle status-icon"></i>
                            <span class="font-weight-bold">Pago</span>
                        </div>`;
                }

                // Atualiza os Mini Cards
                if (document.getElementById('card-pago')) 
                    document.getElementById('card-pago').innerText = formatarParaReal(data.novo_pago);
                if (document.getElementById('card-pendente')) 
                    document.getElementById('card-pendente').innerText = formatarParaReal(data.novo_pendente);
            }
        })
        .catch(error => console.error('Erro:', error));
    });
});
</script>

<style>
/* === ESTILO PARA A TELA (Não muda nada do que você já tinha) === */
/* Alinhamento da coluna de status */
.status-col {
    min-width: 140px; /* Garante que a coluna não mude de largura */
    vertical-align: middle !important;
}

.status-wrapper {
    display: flex;
    align-items: center;
    gap: 8px; /* Espaço entre ícone e texto */
    justify-content: flex-start;
}

.status-icon {
    width: 18px; /* Largura fixa para o ícone não deslocar o texto */
    text-align: center;
    font-size: 1.1rem;
}

/* Efeito de hover para indicar que é clicável */
.form-status:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: 0.2s;
}

.btn-export {
    display: inline-flex;
    align-items: center;
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: bold;
    gap: 8px;
    transition: 0.3s;
}
.btn-excel { background-color: #217346; color: white !important; }
.btn-pdf { background-color: #d32f2f; color: white !important; }
.btn-export:hover { opacity: 0.8; transform: translateY(-1px); }

/* === ESTILO EXCLUSIVO PARA IMPRESSÃO (PDF) === */
@media print {
    /* Esconde elementos inúteis no papel */
    .sidebar, .navbar, .btn-export, .filtros, .no-print, .btn, footer, #id_ano_filtro, #id_mes_filtro, .print,.filtros-form, .text-muted, .main-nav {
        display: none !important;
    }

    /* Reseta margens para o papel */
    body { background-color: white !important; margin: 0; padding: 0; }
    
    /* Faz os cards ficarem lado a lado no PDF */
    .row {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        margin-bottom: 20px !important;
    }
    
    .col-md-4 { width: 32% !important; }
    
    .card {
        border: 1px solid #ddd !important;
        padding: 10px !important;
        box-shadow: none !important;
    }

    /* Garante que as cores de fundo (verde/vermelho) apareçam no PDF */
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    
    .table { width: 100% !important; border-collapse: collapse !important; }
    .table th { background-color: #f8f9fa !important; border: 1px solid #ddd !important; }
    .table td { border: 1px solid #ddd !important; }
}
</style>

{% endblock %}