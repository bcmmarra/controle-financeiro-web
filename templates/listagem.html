{% extends 'base.html' %}

{% block conteudo %}
<h2 class="page-title">Extrato de Transações</h2>

<div class="filtros-container">
    <form method="GET" action="/listagem" class="filtros-form">
        <div class="filtro-grupo">
            <label>Busca</label>
            <input type="text" name="busca" value="{{ request.args.get('busca', '') }}" placeholder="Descrição...">
        </div>

        <div class="filter-item">
            <label>Mês Específico:</label>
            <input type="month" name="mes_filtro" id="id_mes_filtro" class="form-control" 
                value="{{ mes_ano_input }}" 
                onchange="document.getElementById('id_ano_filtro').value = '';">
        </div>

        <div class="filtro-grupo">
            <label>Ver Ano Todo</label>
            <select name="ano_filtro" id="id_ano_filtro" class="form-control"
                    onchange="document.getElementById('id_mes_filtro').value = '';">
                <option value="">Selecione o Ano</option>
                {% for ano in anos %}
                    <option value="{{ ano }}" {{ 'selected' if ano|string == ano_selecionado|string else '' }}>
                        {{ ano }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Método</label>
            <select name="metodo">
                <option value="">Todos</option>
                <option value="Dinheiro" {% if request.args.get('metodo')=='Dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="Cartão de Crédito" {% if request.args.get('metodo')=='Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                <option value="Pix" {% if request.args.get('metodo')=='Pix' %}selected{% endif %}>Pix</option>
                <option value="Boleto" {% if request.args.get('metodo')=='Boleto' %}selected{% endif %}>Boleto</option>
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Status</label>
            <select name="status">
                <option value="">Todos</option>
                <option value="1" {% if request.args.get('status')=='1' %}selected{% endif %}>Pago</option>
                <option value="0" {% if request.args.get('status')=='0' %}selected{% endif %}>Pendente</option>
            </select>
        </div>

        <div class="filtros-acoes">
            <button type="submit" class="btn-filtrar">Filtrar</button>
            <a href="/listagem" class="btn-limpar">Limpar</a>
        </div>
    </form>
    
<hr class="divisor-filtro">

<div class="row mb-2">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #1cc88a; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Receitas (Entradas)</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_receitas | moeda }}</div>
                </div>
                <i class="fas fa-hand-holding-usd fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
        <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #5a5c69; background-color: #f8f9fc; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-muted" style="font-size: 0.8rem; line-height: 1;">Total de Despesas</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_geral | moeda }}</div>
                </div>
                <i class="fas fa-file-invoice-dollar text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm" style="border-left: 5px solid #4e73df; background-color: #f8fbff; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-primary" style="font-size: 0.8rem; line-height: 1;">Saldo Projetado</div>
                    <div class="h5 mb-0 font-weight-bold {{ 'text-danger' if saldo_atual < 0 else 'text-gray-800' }}">
                        {{ saldo_atual | moeda }}
                    </div>
                </div>
                <i class="fas fa-wallet fa-lg text-gray-300"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #28a745; background-color: #f8fff9; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-success" style="font-size: 0.8rem; line-height: 1;">Total Pago</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pago | moeda }}</div>
                </div>
                <i class="fas fa-check-double text-gray-300"></i>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm" style="border-left: 4px solid #fd7e14; background-color: #fffaf5; height: 70px;">
            <div class="card-body d-flex align-items-center justify-content-between py-0" style="height: 100%;">
                <div>
                    <div class="text-uppercase font-weight-bold text-warning" style="font-size: 0.8rem; line-height: 1;">Aguardando Pagamento</div>
                    <div class="h6 mb-0 font-weight-bold text-gray-800">{{ total_pendente | moeda }}</div>
                </div>
                <i class="fas fa-clock text-gray-300"></i>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4 no-print">
    <div class="col-12">
        <div class="card shadow py-1" style="border-left: 10px solid {{ '#e74a3b' if saldo_atual < 0 else '#1cc88a' }}; background-color: {{ '#fff5f5' if saldo_atual < 0 else '#f1fcf4' }}; border-radius: 12px;">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div style="flex-grow: 1;">
                    <div class="text-sm font-weight-bold text-info text-uppercase mb-2">
                        <i class="fas fa-shield-alt"></i> Diagnóstico da Saúde Financeira
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="h3 mb-0 font-weight-bold mr-3 {{ 'text-danger' if saldo_atual < 0 else 'text-success' }}">
                            {{ status_financeiro }}
                        </span>
                        <span class="badge badge-pill badge-dark" style="padding: 6px 10px;">{{ mes_atual_pt }}</span>
                    </div>
                    <p class="text-muted mt-2 mb-0" style="font-size: 0.95rem;">
                        <strong>Dica do Sistema:</strong> {{ sugestao }}
                    </p>
                </div>
                <div class="d-none d-md-block ml-4">
                    <i class="fas {{ 'fa-exclamation-triangle text-danger' if saldo_atual < 0 else 'fa-check-circle text-success' }} fa-4x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="divisor-filtro">


    <div class="export-container no-print">
        <span class="export-label">
            Exportar <strong>{{ rotulo_exportar }}</strong>:
        </span>
        
        <a href="{{ url_for('exportar_excel', **request.args) }}" class="btn-export btn-excel">
            <i class="fas fa-file-excel"></i> Excel
        </a>
        
        <button onclick="window.print()" class="btn-export btn-pdf" style="border: none; cursor: pointer;">
            <i class="fas fa-file-pdf"></i> PDF (Imprimir)
        </button>
    </div>

    <div class="tabela-wrapper">
        <table class="tabela-extrato">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Método</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th class="acoes-col no-print">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transacoes %}
                <tr>
                    <td>{{ t.data_transacao.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {{ t.descricao }}
                        {% if t.is_parcelado %}
                        {% endif %}
                    </td>
                    <td>
                        {% if t.categoria_nome %}
                            <span class="badge-categoria" style="background-color: {{ t.categoria_cor }};">
                                {{ t.categoria_nome if t.categoria_nome else 'Geral' }}
                            </span>
                        {% else %}
                            <span class="badge-categoria" style="background-color: #95a5a6;">
                                Sem Categoria
                            </span>
                        {% endif %}
                    </td>              
                    <td>{{ t.metodo_pagamento }}</td>
                    <td class="valor-celula">{{ t.valor_total | moeda }}</td>
                    <td class="status-celula">
                        <form class="form-status" action="{{ url_for('alternar_pagamento', id=t.id) }}" method="POST">
                            <button type="submit" class="btn-status-toggle" title="Alterar status">
                                <div class="status-container">
                                    {% if t.pago %}
                                    <span class="status-pago">● Pago</span>
                                    {% else %}
                                    <span class="status-pendente">○ Pendente</span>
                                    {% endif %}
                                </div>
                            </button>
                        </form>
                    </td>
                    <td class="acoes-celula no-print">
                        <a href="/editar/{{ t.id }}" class="btn-edit" title="Editar"><i class="fas fa-edit"></i></a>
                        
                        <a href="{{ url_for('excluir', id=t.id) }}" 
                        class="btn-delete" 
                        title="Excluir" 
                        onclick="return confirm('Deseja realmente excluir?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="tabela-vazia">Nenhuma transação encontrada para este período.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<script>
// 1. Função de formatação definida globalmente para o script
const formatarParaReal = (valor) => {
    // Garante que o valor seja um número antes de formatar
    const numero = parseFloat(valor) || 0;
    return numero.toLocaleString('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    });
};

document.querySelectorAll('.form-status').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault(); 
        const url = this.action;
        const container = this.querySelector('.status-container');

        fetch(url, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                // 2. Alterna visualmente o status na tabela
                if (container.innerText.includes('Pago')) {
                    container.innerHTML = '<span class="status-pendente">○ Pendente</span>';
                } else {
                    container.innerHTML = '<span class="status-pago">● Pago</span>';
                }

                // 3. Atualiza os Mini Cards com a formatação profissional
                const cardGasto = document.getElementById('card-gasto');
                const cardPago = document.getElementById('card-pago');
                const cardPendente = document.getElementById('card-pendente');

                if (cardGasto) cardGasto.innerText = formatarParaReal(data.novo_total);
                if (cardPago) cardPago.innerText = formatarParaReal(data.novo_pago);
                if (cardPendente) cardPendente.innerText = formatarParaReal(data.novo_pendente);
            }
        })
        .catch(error => console.error('Erro ao atualizar status:', error));
    });
});
</script>

<style>
/* === ESTILO PARA A TELA (Não muda nada do que você já tinha) === */
.btn-export {
    display: inline-flex;
    align-items: center;
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: bold;
    gap: 8px;
    transition: 0.3s;
}
.btn-excel { background-color: #217346; color: white !important; }
.btn-pdf { background-color: #d32f2f; color: white !important; }
.btn-export:hover { opacity: 0.8; transform: translateY(-1px); }

/* === ESTILO EXCLUSIVO PARA IMPRESSÃO (PDF) === */
@media print {
    /* Esconde elementos inúteis no papel */
    .sidebar, .navbar, .btn-export, .filtros, .no-print, .btn, footer, #id_ano_filtro, #id_mes_filtro, .print,.filtros-form, .text-muted, .main-nav {
        display: none !important;
    }

    /* Reseta margens para o papel */
    body { background-color: white !important; margin: 0; padding: 0; }
    
    /* Faz os cards ficarem lado a lado no PDF */
    .row {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        margin-bottom: 20px !important;
    }
    
    .col-md-4 { width: 32% !important; }
    
    .card {
        border: 1px solid #ddd !important;
        padding: 10px !important;
        box-shadow: none !important;
    }

    /* Garante que as cores de fundo (verde/vermelho) apareçam no PDF */
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    
    .table { width: 100% !important; border-collapse: collapse !important; }
    .table th { background-color: #f8f9fa !important; border: 1px solid #ddd !important; }
    .table td { border: 1px solid #ddd !important; }
}
</style>

{% endblock %}