{% extends 'base.html' %}

{% block conteudo %}
<h2 class="page-title">Extrato de Transações</h2>

<div class="filtros-container">
    <form method="GET" action="/listagem" class="filtros-form">
        <div class="filtro-grupo">
            <label>Busca</label>
            <input type="text" name="busca" value="{{ request.args.get('busca', '') }}" placeholder="Descrição...">
        </div>

        <div class="filter-item">
            <label>Mês Específico:</label>
            <input type="month" name="mes_filtro" id="id_mes_filtro" class="form-control" 
                value="{{ mes_ano_input }}" 
                onchange="document.getElementById('id_ano_filtro').value = '';">
        </div>

        <div class="filtro-grupo">
            <label>Ver Ano Todo</label>
            <select name="ano_filtro" id="id_ano_filtro" class="form-control"
                    onchange="document.getElementById('id_mes_filtro').value = '';">
                <option value="">Selecione o Ano</option>
                {% for ano in anos %}
                    <option value="{{ ano }}" {{ 'selected' if ano|string == ano_selecionado|string else '' }}>
                        {{ ano }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Método</label>
            <select name="metodo">
                <option value="">Todos</option>
                <option value="Dinheiro" {% if request.args.get('metodo')=='Dinheiro' %}selected{% endif %}>Dinheiro</option>
                <option value="Cartão de Crédito" {% if request.args.get('metodo')=='Cartão de Crédito' %}selected{% endif %}>Cartão de Crédito</option>
                <option value="Pix" {% if request.args.get('metodo')=='Pix' %}selected{% endif %}>Pix</option>
                <option value="Boleto" {% if request.args.get('metodo')=='Boleto' %}selected{% endif %}>Boleto</option>
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Status</label>
            <select name="status">
                <option value="">Todos</option>
                <option value="1" {% if request.args.get('status')=='1' %}selected{% endif %}>Pago</option>
                <option value="0" {% if request.args.get('status')=='0' %}selected{% endif %}>Pendente</option>
            </select>
        </div>

        <div class="filtros-acoes">
            <button type="submit" class="btn-filtrar">Filtrar</button>
            <a href="/listagem" class="btn-limpar">Limpar</a>
        </div>
    </form>

    <hr class="divisor-filtro">

    <div class="grid-resumo-extrato">
        <div class="mini-card mini-total">
            <span class="mini-label">Gasto do Mês</span>
            <h2 id="card-gasto" class="mini-valor">{{ total_geral | moeda }}</h2>
        </div>

        <div class="mini-card mini-pago">
            <span class="mini-label">Valor Pago</span>
            <h2 id="card-pago" class="mini-valor">{{ total_pago | moeda }}</h2>
        </div>

        <div class="mini-card mini-pendente">
            <span class="mini-label">Valor Pendente</span>
            <h2 id="card-pendente" class="mini-valor">{{ total_pendente | moeda }}</h2>
        </div>
    </div>
</div>

<div class="export-container no-print">
    <span class="export-label">
        Exportar <strong>{{ rotulo_exportar }}</strong>:
    </span>
    
    <a href="{{ url_for('exportar_excel', **request.args) }}" class="btn-export btn-excel">
        <i class="fas fa-file-excel"></i> Excel
    </a>
    
    <button onclick="window.print()" class="btn-export btn-pdf" style="border: none; cursor: pointer;">
        <i class="fas fa-file-pdf"></i> PDF (Imprimir)
    </button>
</div>

<div class="tabela-wrapper">
    <table class="tabela-extrato">
        <thead>
            <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Método</th>
                <th>Valor</th>
                <th>Status</th>
                <th class="acoes-col no-print">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transacoes %}
            <tr>
                <td>{{ t.data_transacao.strftime('%d/%m/%Y') }}</td>
                <td>
                    {{ t.descricao }}
                    {% if t.is_parcelado %}
                    {% endif %}
                </td>
                <td>
                    {% if t.categoria_nome %}
                        <span class="badge-categoria" style="background-color: {{ t.categoria_cor }};">
                            {{ t.categoria_nome if t.categoria_nome else 'Geral' }}
                        </span>
                    {% else %}
                        <span class="badge-categoria" style="background-color: #95a5a6;">
                            Sem Categoria
                        </span>
                    {% endif %}
                </td>              
                <td>{{ t.metodo_pagamento }}</td>
                <td class="valor-celula">{{ t.valor_total | moeda }}</td>
                <td class="status-celula">
                    <form class="form-status" action="{{ url_for('alternar_pagamento', id=t.id) }}" method="POST">
                        <button type="submit" class="btn-status-toggle" title="Alterar status">
                            <div class="status-container">
                                {% if t.pago %}
                                <span class="status-pago">● Pago</span>
                                {% else %}
                                <span class="status-pendente">○ Pendente</span>
                                {% endif %}
                            </div>
                        </button>
                    </form>
                </td>
                <td class="acoes-celula no-print">
                    <a href="/editar/{{ t.id }}" class="btn-edit" title="Editar"><i class="fas fa-edit"></i></a>
                    
                    <a href="{{ url_for('excluir', id=t.id) }}" 
                    class="btn-delete" 
                    title="Excluir" 
                    onclick="return confirm('Deseja realmente excluir?')">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="tabela-vazia">Nenhuma transação encontrada para este período.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// 1. Função de formatação definida globalmente para o script
const formatarParaReal = (valor) => {
    // Garante que o valor seja um número antes de formatar
    const numero = parseFloat(valor) || 0;
    return numero.toLocaleString('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    });
};

document.querySelectorAll('.form-status').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault(); 
        const url = this.action;
        const container = this.querySelector('.status-container');

        fetch(url, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                // 2. Alterna visualmente o status na tabela
                if (container.innerText.includes('Pago')) {
                    container.innerHTML = '<span class="status-pendente">○ Pendente</span>';
                } else {
                    container.innerHTML = '<span class="status-pago">● Pago</span>';
                }

                // 3. Atualiza os Mini Cards com a formatação profissional
                const cardGasto = document.getElementById('card-gasto');
                const cardPago = document.getElementById('card-pago');
                const cardPendente = document.getElementById('card-pendente');

                if (cardGasto) cardGasto.innerText = formatarParaReal(data.novo_total);
                if (cardPago) cardPago.innerText = formatarParaReal(data.novo_pago);
                if (cardPendente) cardPendente.innerText = formatarParaReal(data.novo_pendente);
            }
        })
        .catch(error => console.error('Erro ao atualizar status:', error));
    });
});
</script>

<style>
/* === ESTILO PARA A TELA (Não muda nada do que você já tinha) === */
.btn-export {
    display: inline-flex;
    align-items: center;
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: bold;
    gap: 8px;
    transition: 0.3s;
}
.btn-excel { background-color: #217346; color: white !important; }
.btn-pdf { background-color: #d32f2f; color: white !important; }
.btn-export:hover { opacity: 0.8; transform: translateY(-1px); }

/* === ESTILO EXCLUSIVO PARA IMPRESSÃO (PDF) === */
@media print {
    /* Esconde elementos inúteis no papel */
    .sidebar, .navbar, .btn-export, .filtros, .no-print, .btn, footer, #id_ano_filtro, #id_mes_filtro, .print,.filtros-form, .text-muted, .main-nav {
        display: none !important;
    }

    /* Reseta margens para o papel */
    body { background-color: white !important; margin: 0; padding: 0; }
    
    /* Faz os cards ficarem lado a lado no PDF */
    .row {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        margin-bottom: 20px !important;
    }
    
    .col-md-4 { width: 32% !important; }
    
    .card {
        border: 1px solid #ddd !important;
        padding: 10px !important;
        box-shadow: none !important;
    }

    /* Garante que as cores de fundo (verde/vermelho) apareçam no PDF */
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    
    .table { width: 100% !important; border-collapse: collapse !important; }
    .table th { background-color: #f8f9fa !important; border: 1px solid #ddd !important; }
    .table td { border: 1px solid #ddd !important; }
}
</style>

{% endblock %}