{% extends 'base.html' %} 

{% block conteudo %}
<div class="form-container-medium">
    <h2 class="page-title">Gerenciar Categorias</h2>

    {% if erro %}
    <div class="alert alert-erro">
        <i class="fas fa-exclamation-circle"></i> {{ erro }}
    </div>
    {% endif %}

    <div class="card card-action-bar shadow-sm p-3 mb-4">
        <form action="/salvar_categoria" method="post" class="container-fluid p-0">
            <div class="row g-2 mb-3">
                <div class="col-12 col-md-6">
                    <label class="form-label small font-weight-bold">Descrição:</label>
                    <input type="text" name="nome_categoria" placeholder="Ex: Lazer, Saúde..." required class="form-control" />
                </div>
                
                <div class="col-7 col-md-4">
                    <label class="form-label small font-weight-bold">Tipo:</label>
                    <select name="tipo" class="form-control" required>
                        <option value="despesa" selected>Despesa (Saída)</option>
                        <option value="receita">Receita (Entrada)</option>
                        <option value="investimento">Investimento (Patrimônio)</option> </select>
                </div>

                <div class="col-5 col-md-2">
                    <label class="form-label small font-weight-bold">Cor:</label>
                    <div class="color-picker-container">
                        <input type="color" name="cor" value="{{ proxima_cor or '#3498db' }}" title="Escolha a cor" class="form-control form-control-color w-100" style="height: 38px;" />
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">
                        <i class="fas fa-plus"></i> Adicionar Categoria
                    </button>
                </div>
            </div>
            
        </form>
    </div>

    <div class="modal fade" id="modalMover" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <form action="/mover_transacoes" method="POST">
            <div class="modal-header">
            <h5 class="modal-title">Reclassificar Transações</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <p>Mover todos os lançamentos de <strong id="nomeOrigem"></strong> para:</p>
            
            <input type="hidden" name="id_origem" id="idOrigemInput">
            
            <select name="id_destino" class="form-control" required>
                <option value="">Selecione a nova categoria...</option>
                {% for cat in categorias %}
                <option value="{{ cat.id }}">{{ cat.nome }}</option>
                {% endfor %}
            </select>
            <small class="text-muted mt-2 d-block">Isso alterará o histórico de todos os lançamentos desta categoria.</small>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Mover Agora</button>
            </div>
        </form>
        </div>
    </div>
    </div>

    <div class="tabela-wrapper shadow-sm rounded">
        <table class="tabela-extrato">
            <thead>
                <tr>
                    <th>Nome da Categoria</th>
                    <th class="text-center">Tipo</th> 
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for c in categorias %}
                <tr>
                    <td class="align-middle">
                        <span class="badge" 
                            style="background-color: {{ c.cor }}; 
                                    color: {{ 'white' if c.cor|lower != '#ffffff' else 'black' }}; 
                                    padding: 8px 12px; 
                                    border-radius: 20px; 
                                    font-weight: bold;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            {{ c.nome }}
                        </span>
                        {% if not c.is_sistema %}
                            <span class="badge-usuario ml-2" title="Categoria criada por você">
                                <i class="fas fa-user-edit"></i>
                            </span>
                        {% endif %}
                    </td>
                    <td class="text-center align-middle">
                        {% if c.tipo|lower == 'despesa' %}
                            <span class="badge-custom badge-vermelho">DESPESA</span>
                        {% elif c.tipo|lower == 'receita' %}
                            <span class="badge-custom badge-verde">RECEITA</span>
                        {% elif c.tipo|lower == 'investimento' %}
                            <span class="badge-custom badge-azul">INVESTIMENTO</span>
                        {% else %}
                            <span class="badge badge-secondary">{{ cat.tipo|upper }}</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            
                            <button type="button" class="btn-edit text-info" title="Mover Transações" 
                                    style="background: none; border: none; padding: 0; font-size: 1.1rem; line-height: 1;"
                                    onclick="abrirModalMover('{{ c.id }}', '{{ c.nome }}')">
                                <i class="fas fa-exchange-alt"></i>
                            </button>

                            <a href="{{ url_for('editar_categoria', id=c.id) }}" class="btn-edit text-primary" title="Editar" style="text-decoration: none;">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            <a href="{{ url_for('excluir_categoria', id=c.id) }}" class="btn-delete text-danger" 
                            title="Excluir" style="text-decoration: none;"
                            onclick="return confirm('Deseja realmente excluir a categoria {{ c.nome }}?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %} 
                <tr>
                    <td colspan="3" class="tabela-vazia" style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <i class="fas fa-folder-open fa-2x mb-2 d-block"></i>
                        Nenhuma categoria cadastrada.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function abrirModalMover(id, nome) {
    document.getElementById('idOrigemInput').value = id;
    document.getElementById('nomeOrigem').innerText = nome;
    var myModal = new bootstrap.Modal(document.getElementById('modalMover'));
    myModal.show();
}
</script>
{% endblock %}