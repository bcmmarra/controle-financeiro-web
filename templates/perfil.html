{% extends 'base.html' %} 

{% block conteudo %}
<div class="form-container-small">
    <h2 class="page-title">Meu Perfil</h2>
    <button onclick="configurarNotificacoes()" class="btn btn-info">
        <i class="fas fa-bell"></i> Ativar Notificações neste Aparelho
    </button>

</br></br>

    {% if mensagem %}
    <div class="alert alert-sucesso">
        {{ mensagem }}
    </div>
    {% endif %}

    <div class="card card-formulario">
        <p class="form-instruction">Altere as suas informações de conta abaixo:</p>

        <form method="post">
            <div class="form-group">
                <label>Nome:</label>
                <input type="text" name="nome" value="{{ usuario.nome }}" class="form-control" required />
            </div>

            <div class="form-group">
                <label>E-mail:</label>
                <input type="email" name="email" value="{{ usuario.email }}" class="form-control" required />
            </div>

            <div class="form-group">
                <label>Senha Atual:</label>
                <input type="password" name="senha_atual" class="form-control" placeholder="Confirme sua senha atual" required />
            </div>

            <div class="form-group">
                <label>Nova Senha (Opcional):</label>
                <input type="password" name="nova_senha" class="form-control" placeholder="Deixe em branco para manter a atual" />
                <small class="form-help">Preencha apenas se desejar alterar sua senha.</small>
            </div>

            <button type="submit" class="btn-confirmar btn-blue">
                Salvar Alterações
            </button>
        </form>
    </div>


</div>

<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-mobile-alt"></i> Meus Dispositivos de Alerta</h5>
    </div>
    <div class="card-body">
        <p class="text-muted small">Estes aparelhos receberão notificações automáticas de contas a vencer.</p>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Dispositivo</th>
                        <th>Cadastrado em</th>
                        <th>Ações</th>
                        <th>Testar Conexão</th>
                    </tr>
                </thead>
                <tbody id="lista-dispositivos">
                    {% for disp in dispositivos %}
                    <tr>
                        <td>{{ disp.nome_dispositivo }}</td>
                        <td>{{ disp.data_criacao.strftime('%d/%m/%Y') }}</td>
                        <td>
                            <button onclick="removerDispositivo({{ disp.id }})" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="enviarTesteIndividual({{ disp.id }})" title="Testar este aparelho">
                                <i class="fas fa-paper-plane"></i> Testar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button onclick="configurarNotificacoes()" class="btn btn-success w-100">
            <i class="fas fa-plus"></i> Cadastrar este aparelho
        </button>
    </div>
</div>

    <div class="danger-zone">
        <h4 class="danger-title"><i class="fas fa-exclamation-triangle"></i> Zona de Perigo</h4>
        <p class="danger-text">Esta ação é irreversível. Todos os seus dados, lançamentos e categorias serão apagados permanentemente.</p>
        
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalExcluir">
            Excluir Minha Conta Permanentemente
        </button>

        <div class="modal fade" id="modalExcluir" tabindex="-1">
            <div class="modal-dialog">
                <form action="{{ url_for('excluir_conta') }}" method="POST" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tem certeza que deseja sair?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sua conta ficará <strong>inativa por 30 dias</strong>. Se você não fizer login nesse período, todos os seus dados serão apagados permanentemente.</p>
                    <div class="mb-3">
                    <label class="form-label">Confirme sua senha para continuar:</label>
                    <input type="password" name="senha_confirmacao" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Inativar minha conta</button>
                </div>
                </form>
            </div>
        </div>


        </form>
    </div>

<script>
function removerDispositivo(id) {
    if (confirm("Deseja parar de receber alertas neste dispositivo?")) {
        fetch(`/remover-dispositivo/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'sucesso') location.reload();
        });
    }
}

function enviarTesteIndividual(id) {
    // Feedback visual imediato
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    btn.disabled = true;

    fetch(`/testar-dispositivo/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                alert("Sinal enviado! Verifique se a notificação apareceu neste aparelho.");
            } else {
                alert("Erro ao testar: " + (data.erro || "Falha desconhecida"));
            }
        })
        .catch(err => alert("Erro na requisição: " + err))
        .finally(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        });
}

// Use a PublicKey que você gerou no Passo 1
const VAPID_PUBLIC_KEY = "BHpp5uohq2AGnx3CQgjB_T15s3c_r8PQsrBMR5oEhNoDgUpRmDizNND727pDCfIoOkqBJ-h3vp6jUA5R25tW7eY";

async function configurarNotificacoes() {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') return;

    // Define o nome do dispositivo (estava faltando no seu bloco anterior)
    const nomePadrao = navigator.userAgent.includes("Mobi") ? "Celular" : "Computador";
    const nomeDispositivo = prompt("Dê um nome para este aparelho:", nomePadrao) || nomePadrao;

    try {
        const register = await navigator.serviceWorker.register('/static/sw.js');
        
        // --- AJUSTE PARA O EDGE ---
        // Espera o Service Worker estar totalmente carregado e ativo
        await navigator.serviceWorker.ready; 

        const existingSubscription = await register.pushManager.getSubscription();
        if (existingSubscription) {
            await existingSubscription.unsubscribe();
        }

        const subscription = await register.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        await fetch('/salvar-inscricao', {
            method: 'POST',
            body: JSON.stringify({
                subscription: subscription,
                nome_dispositivo: nomeDispositivo
            }),
            headers: { 'Content-Type': 'application/json' }
        });

        alert("Pronto! Este aparelho receberá alertas do Descomplica MyFinance.");
        window.location.reload();
    } catch (e) {
        console.error("Erro no registro:", e);
        alert("Erro ao configurar: " + e.message);
    }
}

// 1. Função auxiliar para converter a chave VAPID
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// 2. Função principal
async function configurarNotificacoes() {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
        alert("Você precisa permitir as notificações para receber alertas!");
        return;
    }

    const nomePadrao = navigator.userAgent.includes("Mobi") ? "Celular" : "Computador";
    const nomeDispositivo = prompt("Dê um nome para este aparelho:", nomePadrao) || nomePadrao;

    try {
        const register = await navigator.serviceWorker.register('/static/sw.js');
        
        // --- LIMPEZA CRUCIAL ---
        // Força a remoção de qualquer assinatura antiga com chaves erradas
        const existingSubscription = await register.pushManager.getSubscription();
        if (existingSubscription) {
            await existingSubscription.unsubscribe();
            console.log("Assinatura antiga removida.");
        }

        // Gera a nova assinatura usando a sua VAPID_PUBLIC_KEY atual
        const subscription = await register.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        // Envia para o Flask
        const response = await fetch('/salvar-inscricao', {
            method: 'POST',
            body: JSON.stringify({
                subscription: subscription,
                nome_dispositivo: nomeDispositivo
            }),
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            alert("Aparelho '" + nomeDispositivo + "' cadastrado com sucesso!");
            window.location.reload(); // Recarrega para atualizar a tabela
        } else {
            alert("Erro ao salvar no banco. Verifique se o Flask está rodando.");
        }

    } catch (error) {
        console.error("Erro ao configurar push:", error);
        alert("Erro técnico: " + error.message);
    }
}
</script>

{% endblock %}