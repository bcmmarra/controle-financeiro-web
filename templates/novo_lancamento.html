{% extends 'base.html' %} 

{% block conteudo %}
<div class="form-container-small">
    <div class="card card-formulario shadow" id="card-lancamento">
        <div class="card-header bg-dark text-white transition-all" id="header-lancamento">
            <h3 class="mb-0" id="titulo-form"><i class="fas fa-plus-circle"></i> Novo Lançamento</h3>
        </div>

        <form action="/salvar" method="post" id="form-transacao" class="p-4">
            <div class="form-group mb-4 p-3 rounded" style="background: #f8f9fa;">
                <label class="form-label d-block text-center font-weight-bold mb-3">O que você deseja registrar?</label>
                <div class="d-flex justify-content-center gap-4">
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="tipo_despesa" name="tipo" value="despesa" class="custom-control-input" checked onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-danger font-weight-bold" for="tipo_despesa" style="cursor:pointer">
                            <i class="fas fa-arrow-down"></i> DESPESA
                        </label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="tipo_receita" name="tipo" value="receita" class="custom-control-input" onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-success font-weight-bold" for="tipo_receita" style="cursor:pointer">
                            <i class="fas fa-arrow-up"></i> RECEITA
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Categoria:</label>
                <select name="categoria_id" class="form-control" required>
                    <option value="">Selecione uma categoria...</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Descrição:</label>
                <input type="text" name="descricao" class="form-control" placeholder="Ex: Aluguel, Salário..." required />
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>Valor Total:</label>
                    <input type="text" id="valor_visivel" class="form-control font-weight-bold" placeholder="R$ 0,00" inputmode="numeric" required />
                    <input type="hidden" name="valor_total" id="valor_real">
                </div>

                <div class="form-group col-md-6">
                    <label id="label-data">Data de Vencimento:</label>
                    <input type="date" name="data_transacao" class="form-control" value="{{ hoje }}" required />
                </div>
            </div>

            <div id="secao_detalhes_despesa">
                <div class="form-group">
                    <label>Método de Pagamento:</label>
                    <select name="metodo" id="metodo" class="form-control" onchange="verificarParcelas()">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Boleto">Boleto</option>
                    </select>
                </div>

                <div id="campos_parcelas" class="form-section-highlight border-left-primary p-2 bg-light" style="display: none;">
                    <label class="text-primary font-weight-bold">Quantidade de Parcelas:</label>
                    <input type="number" name="numero_parcelas" class="form-control" value="1" min="1" />
                </div>

                <div class="form-checkbox mt-3 p-2 rounded border">
                    <input type="checkbox" name="pago" id="pago" />
                    <label for="pago" class="mb-0 ml-2" style="cursor:pointer">Esta conta já foi paga?</label>
                </div>
            </div>

            <div class="acoes-form">
                <button type="submit" id="btn-submit" class="btn-acao btn-confirmar-despesa">
                    <i class="fas fa-check"></i> <span>Confirmar Despesa</span>
                </button>
                
                <a href="{{ url_for('listagem') }}" class="btn-acao btn-cancelar">
                    <i class="fas fa-times"></i> Cancelar e Voltar
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    /* Transições suaves para as cores */
    .transition-all { transition: all 0.4s ease; }
    .card-formulario { border-top: 5px solid #343a40; }
    .form-section-highlight { border-left: 4px solid #007bff; margin-top: 10px; }
</style>
{% endblock %}

{% block scripts %}
<script>
    function ajustarVisibilidade() {
        const isDespesa = document.getElementById("tipo_despesa").checked;
        const secaoDetalhes = document.getElementById("secao_detalhes_despesa");
        const card = document.getElementById("card-lancamento");
        const header = document.getElementById("header-lancamento");
        const btn = document.getElementById("btn-submit");
        const labelData = document.getElementById("label-data");
        const titulo = document.getElementById("titulo-form");

        if (isDespesa) {
            // TEMA DESPESA (Vermelho)
            secaoDetalhes.style.display = "block";
            header.style.backgroundColor = "#e74c3c";
            card.style.borderColor = "#e74c3c";
            btn.className = "btn btn-danger btn-block btn-lg";
            btn.innerHTML = "Confirmar Despesa";
            labelData.innerText = "Data de Vencimento:";
            titulo.innerHTML = '<i class="fas fa-arrow-down"></i> Nova Despesa';
        } else {
            // TEMA RECEITA (Verde)
            secaoDetalhes.style.display = "none"; // Esconde parcelas e pago
            header.style.backgroundColor = "#27ae60";
            card.style.borderColor = "#27ae60";
            btn.className = "btn btn-success btn-block btn-lg";
            btn.innerHTML = "Confirmar Receita";
            labelData.innerText = "Data de Recebimento:";
            titulo.innerHTML = '<i class="fas fa-arrow-up"></i> Nova Receita';
            
            // Força o checkbox pago para true internamente, 
            // já que a seção está oculta e receitas são sempre pagas
            document.getElementById("pago").checked = true;
        }
    }

    function verificarParcelas() {
        const metodo = document.getElementById("metodo").value;
        const div = document.getElementById("campos_parcelas");
        if (div) div.style.display = (metodo === "Cartão de Crédito") ? "block" : "none";
    }

    // Máscara de Moeda
    const inputVisivel = document.getElementById('valor_visivel');
    const inputOculto = document.getElementById('valor_real');

    if (inputVisivel) {
        inputVisivel.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, "");
            value = (value / 100).toFixed(2) + "";
            value = value.replace(".", ",");
            value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
            e.target.value = value ? "R$ " + value : "";
            if (value) inputOculto.value = value.replace(/\./g, "").replace(",", ".");
        });
    }

    window.onload = ajustarVisibilidade;
</script>
{% endblock %}