{% extends 'base.html' %} 

{% block conteudo %}
<div class="form-container-small">
    <div class="card card-formulario shadow" id="card-lancamento">
        <div class="card-header bg-dark text-white transition-all" id="header-lancamento">
            <h3 class="mb-0" id="titulo-form"><i class="fas fa-plus-circle"></i> Novo Lançamento</h3>
        </div>

        <form action="{{ url_for('novo_lancamento') }}" method="post" id="form-transacao" class="p-4">
            <div class="form-group mb-4 p-3 rounded" style="background: #f8f9fa;">
                <label class="form-label d-block text-center font-weight-bold mb-3">O que você deseja registrar?</label>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="tipo_despesa" name="tipo" value="despesa" class="custom-control-input" checked onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-danger font-weight-bold" for="tipo_despesa" style="cursor:pointer">
                            <i class="fas fa-arrow-down"></i> DESPESA
                        </label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="tipo_receita" name="tipo" value="receita" class="custom-control-input" onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-success font-weight-bold" for="tipo_receita" style="cursor:pointer">
                            <i class="fas fa-arrow-up"></i> RECEITA
                        </label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input type="radio" id="tipo_investimento" name="tipo" value="investimento" class="custom-control-input" onchange="ajustarVisibilidade()">
                        <label class="custom-control-label text-primary font-weight-bold" for="tipo_investimento" style="cursor:pointer">
                            <i class="fas fa-chart-line"></i> INVESTIMENTO
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="font-weight-bold"><i id="icon-categoria" class="fas fa-tags mr-1"></i> Categoria:</label>
                <select name="categoria_id" id="select_categoria" class="form-control" required>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}" data-tipo="{{ cat.tipo }}">{{ cat.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="font-weight-bold"><i id="icon-descricao" class="fas fa-pen mr-1"></i> Descrição:</label>
                <input type="text" name="descricao" class="form-control" placeholder="Ex: Aluguel, Salário..." required />
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label small font-weight-bold">
                        <i id="icon-valor" class="fas fa-coins mr-1"></i> Valor Total:
                    </label>
                    <div class="input-group">
                        <input type="text" id="valor_visivel" class="form-control font-weight-bold" placeholder="R$ 0,00" inputmode="numeric" required />
                        <input type="hidden" name="valor_total" id="valor_real">
                    </div>
                </div>
                <div class="col-6">
                    <label class="form-label small font-weight-bold" id="label-data">Data:</label>
                    <input type="date" name="data_transacao" class="form-control" value="{{ hoje }}" required />
                </div>
            </div>

            <div class="form-checkbox mb-3 p-2 rounded border bg-white shadow-sm">
                <input class="checkbox" type="checkbox" name="is_recorrente" id="is_recorrente" onchange="toggleRecorrencia()">
                <label class="form-check-label mb-0 ml-2 font-weight-bold" style="cursor:pointer" for="is_recorrente">
                    <i class="fas fa-sync-alt"></i> Lançamento Recorrente
                </label>
                
                <div id="divMeses" class="form-section-highlight border-left-primary p-2 mt-2 bg-light" style="display: none; border-left: 4px solid #8c00ff !important">
                    <label for="meses_recorrencia" class="form-label small">Repetir por quantos meses?</label>
                    <input type="number" class="form-control form-control-sm" name="meses_recorrencia" id="meses_recorrencia" value="12" min="2" max="60">
                    <small class="text-muted">*(Mínimo: 2 | Máximo: 60 meses)</small>
                </div>
            </div>
            <div id="secao_detalhes_despesa">
                <div class="form-group">
                    <label class="font-weight-bold">Método de Pagamento:</label>
                    <select name="metodo" id="metodo" class="form-control" onchange="gerenciarCamposParcelas()">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Boleto">Boleto</option>
                    </select>
                </div>

                <div id="campos_parcelas" class="form-section-highlight border-left-primary p-2 bg-light mb-3" style="display: none;">
                    <label class="text-primary font-weight-bold small">Quantidade de Parcelas:</label>
                    <input type="number" name="numero_parcelas" id="numero_parcelas" class="form-control" value="1" min="1" />
                </div>

                <div class="form-checkbox mt-3 p-2 rounded border bg-white shadow-sm">
                    <input type="checkbox" name="pago" id="pago" />
                    <label for="pago" id="label-pago" class="mb-0 ml-2" style="cursor:pointer">
                        Esta conta já foi paga?
                    </label>
                </div>
            </div>

            <div class="acoes-form mt-4">
                <button type="submit" id="btn-submit" class="btn btn-block btn-lg transition-all text-white font-weight-bold">
                    <i class="fas fa-check"></i> <span>Confirmar</span>
                </button>
                <a href="{{ url_for('listagem') }}" class="btn btn-link btn-block text-muted mt-2">
                    <i class="fas fa-times"></i> Cancelar e Voltar
                </a>
            </div>
        </form>
    </div>
</div>

<style>
    .transition-all { transition: all 0.3s ease; }
    .card-formulario { border-top: 5px solid #343a40; border-radius: 12px; }
    .form-section-highlight { border-left: 4px solid #007bff; margin-top: 10px; }
    #btn-submit { min-height: 50px; text-transform: uppercase; letter-spacing: 1px; }
    .input-group-text { background: #f8f9fa; }
</style>
{% endblock %}

{% block scripts %}
<script>
    function ajustarVisibilidade() {
        const tipoSelecionado = document.querySelector('input[name="tipo"]:checked').value;
        const selectCat = document.getElementById("select_categoria");
        const labelData = document.getElementById("label-data");
        const secaoDetalhes = document.getElementById("secao_detalhes_despesa");
        const labelPago = document.getElementById("label-pago");
        const checkboxPago = document.getElementById("pago");
        const header = document.getElementById("header-lancamento");
        const btn = document.getElementById("btn-submit");
        const titulo = document.getElementById("titulo-form");

        const icones = [
            document.getElementById("icon-categoria"),
            document.getElementById("icon-descricao"),
            document.getElementById("icon-valor")
        ];

        let corBase = "";
        let textoData = "";
        let textoTitulo = "";

        if (tipoSelecionado === "despesa") {
            corBase = "#e74c3c";
            textoData = "Data de Vencimento:";
            textoTitulo = '<i class="fas fa-arrow-down"></i> Nova Despesa';
            labelPago.innerText = "Esta conta já foi paga?";
            secaoDetalhes.style.display = "block";
        } 
        else if (tipoSelecionado === "receita") {
            corBase = "#27ae60";
            textoData = "Data de Recebimento:";
            textoTitulo = '<i class="fas fa-arrow-up"></i> Nova Receita';
            secaoDetalhes.style.display = "none"; 
        }
        else if (tipoSelecionado === "investimento") {
            corBase = "#3498db";
            textoData = "Data do Aporte:";
            textoTitulo = '<i class="fas fa-chart-line"></i> Novo Investimento';
            labelPago.innerText = "Este aporte já foi realizado?";
            secaoDetalhes.style.display = "block";
            checkboxPago.checked = true; 
        }

        header.style.backgroundColor = corBase;
        titulo.innerHTML = textoTitulo;
        btn.style.backgroundColor = corBase;
        btn.style.borderColor = corBase;
        btn.querySelector('span').innerText = `Confirmar ${tipoSelecionado.charAt(0).toUpperCase() + tipoSelecionado.slice(1)}`;

        labelData.innerHTML = `<i class="fas fa-calendar-alt mr-1" style="color: ${corBase}"></i> ${textoData}`;
        icones.forEach(icon => { if (icon) icon.style.color = corBase; });

        // Filtrar Categorias
        const options = selectCat.options;
        let primeiraEncontrada = null;
        for (let i = 0; i < options.length; i++) {
            const optionTipo = options[i].getAttribute("data-tipo");
            if (optionTipo === tipoSelecionado) {
                options[i].style.display = "block";
                if (!primeiraEncontrada) primeiraEncontrada = options[i].value;
            } else {
                options[i].style.display = "none";
            }
        }
        if (primeiraEncontrada) selectCat.value = primeiraEncontrada;
        
        gerenciarCamposParcelas();
    }

    function gerenciarCamposParcelas() {
        const tipoRadio = document.querySelector('input[name="tipo"]:checked');
        const metodoPgto = document.getElementById('metodo');
        const divParcelas = document.getElementById('campos_parcelas');
        const checkRecorrente = document.getElementById("is_recorrente");

        if (tipoRadio && tipoRadio.value === "despesa" && metodoPgto.value === "Cartão de Crédito" && !checkRecorrente.checked) {
            divParcelas.style.display = "block";
        } else {
            divParcelas.style.display = "none";
            document.getElementById('numero_parcelas').value = 1;
        }
    }

    function toggleRecorrencia() {
        const checkBox = document.getElementById("is_recorrente");
        const divMeses = document.getElementById("divMeses");
        
        divMeses.style.display = checkBox.checked ? "block" : "none";
        gerenciarCamposParcelas();
    }

    // Máscara R$
    const inputVisivel = document.getElementById('valor_visivel');
    const inputOculto = document.getElementById('valor_real');
    inputVisivel.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, "");
        value = (value / 100).toFixed(2) + "";
        if (value === "0.00") { inputOculto.value = ""; e.target.value = ""; return; }
        inputOculto.value = value;
        e.target.value = "R$ " + value.replace(".", ",").replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,").replace(/(\d)(\d{3}),/g, "$1.$2,");
    });

    window.onload = ajustarVisibilidade;
</script>
{% endblock %}